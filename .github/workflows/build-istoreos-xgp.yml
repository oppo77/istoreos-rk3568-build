name: ã€æœ€ç»ˆç‰ˆã€‘ç¼–è¯‘ iStoreOS å›ºä»¶ï¼ˆRK3568 + ä¿®å¤libtoolå®‰è£…ï¼‰

# ç¯å¢ƒå˜é‡ç»Ÿä¸€ç®¡ç†
env:
  SOURCE_REPO: "https://github.com/oppo77/istoreos-rk3568-build.git"
  CONFIG_URL: "https://raw.githubusercontent.com/oppo77/istoreos-rk3568-build/refs/heads/main/xgp.config"
  FIRMWARE_DIR: "./openwrt/bin/targets/rockchip/armv8"
  CCACHE_DIR: "./.ccache"
  LOG_DIR: "./build-logs"

on:
  workflow_dispatch:
    inputs:
      wifi_2g_ssid:
        description: "2.4G WiFiåç§°"
        required: true
        default: "iStoreOS-2.4G"
      wifi_2g_pass:
        description: "2.4G WiFiå¯†ç ï¼ˆ8-63ä½ï¼‰"
        required: true
        default: "12345678"
      wifi_5g_ssid:
        description: "5G WiFiåç§°"
        required: true
        default: "iStoreOS-5G"
      wifi_5g_pass:
        description: "5G WiFiå¯†ç ï¼ˆ8-63ä½ï¼‰"
        required: true
        default: "12345678"
      apn_5g:
        description: "5Gæ¨¡å—APN"
        required: true
        default: "cmnet"
  push:
    branches:
      - main

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    steps:
      ###########################################################################
      # å‰ç½®ç¼“å­˜ï¼šä¿®å¤è¯­æ³•é”™è¯¯ï¼ˆgithub.sha[:8] â†’ github.sha | slice: 0, 8ï¼‰
      ###########################################################################
      - name: 0. åˆå§‹åŒ–ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            /var/cache/apt/archives
          key: ${{ runner.os }}-build-cache-${{ github.sha | slice: 0, 8 }}  # ä¿®å¤è¯­æ³•
          restore-keys: |
            ${{ runner.os }}-build-cache-

      ###########################################################################
      # åŸºç¡€å‡†å¤‡ï¼šæ‹‰å–ä»£ç +æ¸…ç†ç£ç›˜ï¼ˆç¡®ä¿ç©ºé—´ï¼‰
      ###########################################################################
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          timeout-minutes: 10

      - name: 2. æ·±åº¦æ¸…ç†ç£ç›˜
        run: |
          echo "=== æ¸…ç†å‰ç£ç›˜ç©ºé—´ ==="
          df -h /
          
          sudo rm -rf /usr/share/dotnet /usr/local/share/powershell /usr/local/lib/android /opt/ghc || true
          sudo apt-get -y purge azure-cli* docker* ghc* zulu* llvm* firefox google* powershell* dotnet* mono* || true
          sudo apt-get autoremove -y && sudo apt-get clean
          
          echo "=== æ¸…ç†åç£ç›˜ç©ºé—´ ==="
          df -h /
          FREE_SPACE=$(df -P / | awk 'NR==2 {print $4}')
          if [ $FREE_SPACE -lt 26214400 ]; then
            echo "âŒ é”™è¯¯ï¼šç£ç›˜ç©ºé—´ä¸è¶³25GBï¼"
            exit 1
          fi

      ###########################################################################
      # æ ¸å¿ƒä¿®å¤ï¼šå¤šæ–¹æ¡ˆå®‰è£…libtoolï¼ˆè§£å†³å®‰è£…å¤±è´¥ï¼‰
      ###########################################################################
      - name: 3. å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆé‡ç‚¹ä¿®å¤libtoolï¼‰
        run: |
          echo "=== ğŸ”§ å¼€å§‹å®‰è£…ä¾èµ–ï¼ˆä¼˜å…ˆå¤„ç†libtoolï¼‰ ==="
          # æ­¥éª¤1ï¼šåˆ‡æ¢å›½å†…aptæºï¼ˆé˜¿é‡Œäº‘ï¼Œè§£å†³é»˜è®¤æºåŒæ­¥å»¶è¿Ÿï¼‰
          sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
          sudo echo "deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse
          deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse
          deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse
          deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse" > /etc/apt/sources.list
          
          # æ­¥éª¤2ï¼šæ¸…ç†aptç¼“å­˜+æ›´æ–°æº
          sudo apt-get clean
          sudo apt-get update -y --fix-missing  # ä¿®å¤ç¼ºå¤±çš„æºç´¢å¼•
          
          # æ­¥éª¤3ï¼šå°è¯•å¸¸è§„å®‰è£…ï¼ˆå«libtoolï¼‰
          DEPS="axel ccache git build-essential libncurses5-dev libssl-dev \
            flex bison make gcc g++ gettext python3 python3-pip python3-setuptools \
            unzip wget curl nano file qemu-utils libtool"
          sudo apt-get install -y $DEPS
          
          # æ­¥éª¤4ï¼šæ ¡éªŒlibtoolæ˜¯å¦å®‰è£…æˆåŠŸï¼Œå¤±è´¥åˆ™æ‰‹åŠ¨ä¸‹è½½debåŒ…å…œåº•
          if command -v libtool &> /dev/null; then
            echo "âœ… libtoolå¸¸è§„å®‰è£…æˆåŠŸï¼"
          else
            echo "âš ï¸  å¸¸è§„å®‰è£…å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ä¸‹è½½debåŒ…å®‰è£…..."
            # æ‰‹åŠ¨ä¸‹è½½Ubuntu 22.04 aarch64çš„libtool debåŒ…ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰
            axel -n 8 -o libtool.deb "http://mirrors.aliyun.com/ubuntu/pool/main/libt/libtool/libtool_2.4.6-15ubuntu1_amd64.deb"
            # å¼ºåˆ¶å®‰è£…debåŒ…
            sudo dpkg -i libtool.deb || sudo apt-get -f install -y  # è‡ªåŠ¨ä¿®å¤ä¾èµ–
            # äºŒæ¬¡æ ¡éªŒ
            if ! command -v libtool &> /dev/null; then
              echo "âŒ é”™è¯¯ï¼šlibtoolæ‰‹åŠ¨å®‰è£…ä¹Ÿå¤±è´¥ï¼"
              exit 1
            fi
            echo "âœ… libtoolæ‰‹åŠ¨å®‰è£…æˆåŠŸï¼"
          fi
          
          # æ ¡éªŒå…¶ä»–å…³é”®å·¥å…·
          TOOLS=("axel" "ccache" "git" "make" "gcc" "g++")
          for tool in "${TOOLS[@]}"; do
            if ! command -v $tool &> /dev/null; then
              echo "âŒ é”™è¯¯ï¼šå·¥å…· $tool å®‰è£…å¤±è´¥ï¼"
              exit 1
            fi
          done
          echo "=== âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ ==="

      ###########################################################################
      # æºç ä¸é…ç½®ï¼šå®Œå…¨ä¿ç•™åŸå§‹é…ç½®ï¼Œä»…æ ¡éªŒå®Œæ•´æ€§
      ###########################################################################
      - name: 4. å…‹éš†iStoreOSæºç 
        run: |
          echo "=== å…‹éš†æºç  ==="
          git clone --depth 1 ${{ env.SOURCE_REPO }} openwrt
          cd openwrt
          git checkout refs/heads/main
          
          REQUIRED_DIRS=("package" "target" "include")
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "./$dir" ]; then
              echo "âŒ æºç ç›®å½• $dir ç¼ºå¤±ï¼"
              exit 1
            fi
          done
          echo "=== âœ… æºç å…‹éš†å®Œæˆ ==="

      - name: 5. ä¸‹è½½åŸå§‹xgp.configï¼ˆä¸åšä»»ä½•ä¿®æ”¹ï¼‰
        run: |
          cd openwrt
          echo "=== ä¸‹è½½åŸå§‹é…ç½® ==="
          axel -n 8 -o .config ${{ env.CONFIG_URL }}
          
          if [ ! -f ".config" ] || [ $(wc -l < .config) -lt 100 ]; then
            echo "âŒ é…ç½®æ–‡ä»¶æŸåï¼"
            exit 1
          fi
          
          if ! grep -q "CONFIG_MACH_ROCKCHIP_RK3568=y" .config; then
            echo "âŒ æœªå¯ç”¨RK3568é…ç½®ï¼"
            exit 1
          fi
          
          echo "=== âœ… åŸå§‹é…ç½®æ ¡éªŒå®Œæˆï¼ˆæœªä¿®æ”¹ï¼‰ ==="

      ###########################################################################
      # å·¥å…·ä¿®å¤+ç¼–è¯‘å‡†å¤‡ï¼šç¡®ä¿ipkg-make-indexå¯ç”¨
      ###########################################################################
      - name: 6. ä¿®å¤ipkg-make-indexå·¥å…·
        run: |
          cd openwrt
          TOOL_PATH=$(find ./staging_dir -name "ipkg-make-index" -type f | head -1)
          
          if [ -z "$TOOL_PATH" ]; then
            echo "=== ç¼–è¯‘opkgä¸»æœºç«¯ ==="
            make package/system/opkg/host-compile -j1 V=s
            TOOL_PATH=$(find ./staging_dir -name "ipkg-make-index" -type f | head -1)
            if [ -z "$TOOL_PATH" ]; then
              echo "âŒ opkgç¼–è¯‘å¤±è´¥ï¼"
              exit 1
            fi
          fi
          
          chmod +x "$TOOL_PATH"
          if ! "$TOOL_PATH" --help > /dev/null 2>&1; then
            echo "âŒ å·¥å…·ä¸å¯æ‰§è¡Œï¼"
            exit 1
          fi
          
          export PATH=$PATH:$(dirname "$TOOL_PATH")
          echo "=== âœ… å·¥å…·éªŒè¯é€šè¿‡ ==="

      - name: 7. é…ç½®axelä¸‹è½½+æ¸…ç†æ—§äº§ç‰©
        run: |
          cd openwrt
          # ä¼˜åŒ–ä¸‹è½½
          sed -i 's/^WGET_CMD.*/WGET_CMD = axel -n 8 -a -o $(DL_DIR)\/\$(FILE) $(URL)/' ./include/download.mk
          echo "DOWNLOAD_TIMEOUT=1200" >> ./include/download.mk
          echo "CONFIG_CCACHE=y" >> .config
          
          # æ¸…ç†æ—§äº§ç‰©
          make clean && make dirclean
          ccache -C
          mkdir -p ${{ env.LOG_DIR }}
          echo "=== âœ… å‡†å¤‡å®Œæˆ ==="

      ###########################################################################
      # å›ºä»¶ç¼–è¯‘+äº§ç‰©æ•´ç†ï¼šå¸¦æ—¥å¿—ä¿å­˜+MD5æ ¡éªŒ
      ###########################################################################
      - name: 8. ç¼–è¯‘å›ºä»¶ï¼ˆå•çº¿ç¨‹+æ—¥å¿—ä¿å­˜ï¼‰
        run: |
          cd openwrt
          TOOL_PATH=$(find ./staging_dir -name "ipkg-make-index" -type f | head -1)
          export PATH=$PATH:$(dirname "$TOOL_PATH")
          
          echo "=== å¼€å§‹ç¼–è¯‘ ==="
          make -j1 V=s 2>&1 | tee ${{ env.LOG_DIR }}/compile.log
          
          if [ ! -d "${{ env.FIRMWARE_DIR }}" ] || ! ls "${{ env.FIRMWARE_DIR }}"/*.img* &> /dev/null; then
            echo "âŒ å›ºä»¶ç”Ÿæˆå¤±è´¥ï¼"
            exit 1
          fi
          echo "=== âœ… ç¼–è¯‘æˆåŠŸ ==="

      - name: 9. æ•´ç†äº§ç‰©ï¼ˆMD5+ä¿¡æ¯æ¸…å•ï¼‰
        run: |
          mkdir -p final-firmware
          cp "${{ env.FIRMWARE_DIR }}"/*.img.gz final-firmware/ || true
          cp "${{ env.FIRMWARE_DIR }}"/*.img final-firmware/ || true
          
          # MD5æ ¡éªŒ
          cd final-firmware
          for file in *.img*; do
            md5sum "$file" >> MD5æ ¡éªŒå€¼.txt
          done
          
          # ä¿¡æ¯æ¸…å•
          echo "======================================" > å›ºä»¶ä¿¡æ¯.txt
          echo "         iStoreOSå›ºä»¶ä¿¡æ¯ï¼ˆRK3568ï¼‰     " >> å›ºä»¶ä¿¡æ¯.txt
          echo "======================================" >> å›ºä»¶ä¿¡æ¯.txt
          echo "ç¼–è¯‘æ—¶é—´ï¼š$(date +"%Y-%m-%d %H:%M:%S")" >> å›ºä»¶ä¿¡æ¯.txt
          echo "é…ç½®æ–‡ä»¶ï¼š${{ env.CONFIG_URL }}ï¼ˆåŸå§‹é…ç½®ï¼‰" >> å›ºä»¶ä¿¡æ¯.txt
          echo "WiFiï¼š2.4G=${{ github.event.inputs.wifi_2g_ssid }} / 5G=${{ github.event.inputs.wifi_5g_ssid }}" >> å›ºä»¶ä¿¡æ¯.txt
          echo "5G APNï¼š${{ github.event.inputs.apn_5g }}" >> å›ºä»¶ä¿¡æ¯.txt
          echo "======================================" >> å›ºä»¶ä¿¡æ¯.txt
          echo "MD5æ ¡éªŒå€¼ï¼š" >> å›ºä»¶ä¿¡æ¯.txt
          cat MD5æ ¡éªŒå€¼.txt >> å›ºä»¶ä¿¡æ¯.txt
          
          echo "=== âœ… äº§ç‰©æ•´ç†å®Œæˆ ==="

      ###########################################################################
      # äº§ç‰©ä¸Šä¼ ï¼šä¿®å¤è¯­æ³•é”™è¯¯ï¼ˆgithub.sha[:8] â†’ github.sha | slice: 0, 8ï¼‰
      ###########################################################################
      - name: 10. ä¸Šä¼ å›ºä»¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: iStoreOS-RK3568-å›ºä»¶-${{ github.run_number }}-${{ github.sha | slice: 0, 8 }}  # ä¿®å¤è¯­æ³•
          path: final-firmware/
          retention-days: 30
          if-no-files-found: error

      - name: 11. å¤±è´¥å…œåº•ï¼šä¸Šä¼ ç¼–è¯‘æ—¥å¿—
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ç¼–è¯‘å¤±è´¥æ—¥å¿—-${{ github.run_number }}
          path: ${{ env.LOG_DIR }}/compile.log
          retention-days: 15
