name: Build iStoreOS for XGP with 5G Support

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-istoreos-xgp.yml'
      - 'configs/xgp-5g.config'  # 明确监控 configs 目录下的配置文件

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 480

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev lib32gcc-s1 \
            libc6-dev-i386 libelf-dev libglib2.0-dev xmlto qemu-utils upx-ucl liblzma-dev file wget curl
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: Clone iStoreOS source
        run: |
          git clone --depth=1 https://github.com/istoreos/istoreos.git istoreos
          cd istoreos
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Integrate 5G-Modem-Support
        run: |
          cd istoreos
          # 移除冲突驱动
          rm -rf package/feeds/packages/quectel-MHI
          rm -rf package/feeds/packages/qmi-utils
          rm -rf package/feeds/packages/wwan
          # 克隆5G支持仓库
          git clone --depth=1 https://github.com/Siriling/5G-Modem-Support.git package/5G-Modem-Support
          ./scripts/feeds install -a -p 5G-Modem-Support

      - name: Load custom config (带路径调试)
        run: |
          # 调试：打印当前工作目录和仓库根目录
          echo "当前工作目录: $(pwd)"
          echo "仓库根目录: $GITHUB_WORKSPACE"
          
          # 调试：检查 configs 目录是否存在，以及目录下的文件
          echo "检查 configs 目录是否存在..."
          if [ -d "$GITHUB_WORKSPACE/configs" ]; then
            echo "configs 目录存在，目录下的文件列表："
            ls -la "$GITHUB_WORKSPACE/configs"
          else
            echo "错误：configs 目录不存在！"
            exit 1
          fi
          
          # 调试：检查目标配置文件是否存在
          CONFIG_FILE="$GITHUB_WORKSPACE/configs/xgp-5g.config"
          if [ -f "$CONFIG_FILE" ]; then
            echo "配置文件存在：$CONFIG_FILE"
          else
            echo "错误：配置文件 $CONFIG_FILE 不存在！"
            exit 1
          fi
          
          # 复制配置文件到编译目录
          cd istoreos
          cp "$CONFIG_FILE" .config
          make defconfig

      - name: Build firmware (控制日志大小)
        run: |
          cd istoreos
          export BUILD_LOG=build.log
          (make -j$(nproc) V=s 2>&1 | tee $BUILD_LOG) || (tail -n 500 $BUILD_LOG && exit 1)
          gzip $BUILD_LOG

      - name: Collect output
        run: |
          mkdir -p output
          cp istoreos/bin/targets/*/*/*.img.gz output/
          cp istoreos/bin/targets/*/*/*.tar.gz output/
          cp istoreos/build.log.gz output/
          ls -lh output/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: istoreos-xgp-5g-firmware
          path: output/
          retention-days: 7
