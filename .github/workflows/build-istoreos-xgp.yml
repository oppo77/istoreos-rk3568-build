name: ç¼–è¯‘iStoreOS-XGPï¼ˆå¸¦QModem5Gä¸è‡ªåŠ¨é…ç½®ï¼‰

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-istoreos-xgp.yml'
      - 'xgp-qmodem.config'
      - 'files/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TARGET_PLATFORM: rockchip
      TARGET_SUBPLATFORM: rk35xx
      FIRMWARE_DIST: istoreos

    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip \
            python3 python3-pip python3-setuptools python3-yaml \
            flex bison bc quilt libelf-dev libffi-dev dwarves \
            u-boot-tools dosfstools mtools parted gcc-multilib

      - name: 3. å…‹éš†iStoreOSæºç 
        run: |
          git clone https://github.com/istoreos/istoreos.git $FIRMWARE_DIST
          cd $FIRMWARE_DIST
          git checkout $(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+' | head -1)

      - name: 4. é›†æˆQModem
        run: |
          cd $FIRMWARE_DIST
          echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default
          ./scripts/feeds update -a > /dev/null 2>&1
          ./scripts/feeds install -a -f

      - name: 5. ä¸‹è½½é…ç½®æ–‡ä»¶ï¼ˆ100%æ­£ç¡®é“¾æ¥ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
        run: |
          cd $FIRMWARE_DIST
          # ğŸ‘‡ ä»¥ä¸‹æ˜¯ä½ çš„é…ç½®æ–‡ä»¶çš„ã€å”¯ä¸€æ­£ç¡®é“¾æ¥ã€‘ï¼Œå·²å½»åº•å›ºåŒ–
          CORRECT_URL="https://raw.githubusercontent.com/oppo77/istoreos-rk3568-build/main/xgp-qmodem.config"
          echo "æ­£åœ¨ä½¿ç”¨çš„æ­£ç¡®é“¾æ¥ï¼š$CORRECT_URL"
          
          # ç›´æ¥ä¸‹è½½ï¼Œå¢åŠ è¶…æ—¶å’Œè¯ä¹¦å®¹é”™ï¼Œé¿å…ç½‘ç»œ/è¯ä¹¦é—®é¢˜
          if ! wget --no-check-certificate --timeout=10 -O .config "$CORRECT_URL"; then
            echo "ERROR: é…ç½®æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼è¯·ç«‹å³æ£€æŸ¥ä»¥ä¸‹2ç‚¹ï¼š"
            echo "1. é“¾æ¥æ˜¯å¦è¢«æ‰‹åŠ¨ä¿®æ”¹ï¼Ÿæ­£ç¡®é“¾æ¥å¿…é¡»æ˜¯ï¼š$CORRECT_URL"
            echo "2. ä»“åº“ 'oppo77/istoreos-rk3568-build' æ˜¯å¦ä¸ºã€å…¬å¼€ä»“åº“ã€‘ï¼ˆç§æœ‰ä»“åº“æ— æƒé™è®¿é—®ï¼‰"
            echo "3. ç¡®è®¤ 'main' åˆ†æ”¯ä¸‹ç¡®å®å­˜åœ¨ 'xgp-qmodem.config' æ–‡ä»¶ï¼ˆæ— æ‹¼å†™é”™è¯¯ï¼‰"
            exit 1
          fi
          
          # éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦å®Œæ•´ï¼ˆå¿…é¡»åŒ…å«ç›®æ ‡å¹³å°é…ç½®ï¼‰
          if ! grep -q "CONFIG_TARGET_DEVICE_rockchip_rk35xx_DEVICE_nlnet_xgp=y" .config; then
            echo "ERROR: ä¸‹è½½çš„æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„xgpé…ç½®æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯æ–‡ä»¶æŸåæˆ–é“¾æ¥é”™ï¼"
            exit 1
          fi
          
          # ç”Ÿæˆç¼–è¯‘é…ç½®å¹¶éªŒè¯QModem
          make defconfig
          if ! grep -q "CONFIG_PACKAGE_luci-app-qmodem=y" .config; then
            echo "ERROR: é…ç½®æ–‡ä»¶ä¸­æœªå¯ç”¨QModemï¼Œè¯·æ£€æŸ¥xgp-qmodem.configï¼"
            exit 1
          fi

      - name: 6. å¤åˆ¶é¢„é…ç½®æ–‡ä»¶
        run: |
          cd $FIRMWARE_DIST
          if [ -d "../files" ]; then
            cp -r ../files/ ./files/
            echo "å·²å¤åˆ¶é¢„é…ç½®æ–‡ä»¶ï¼š"
            ls -R ./files
          else
            echo "ERROR: ä»“åº“æ ¹ç›®å½•ç¼ºå°‘filesç›®å½•ï¼è¯·æŒ‰è¯´æ˜åˆ›å»ºfiles/etc/configç­‰ç»“æ„"
            exit 1
          fi

      - name: 7. ç¼–è¯‘å›ºä»¶
        run: |
          cd $FIRMWARE_DIST
          make -j$(nproc) V=sc 2>&1 | tee build.log
          FIRMWARE_DIR="bin/targets/$TARGET_PLATFORM/$TARGET_SUBPLATFORM"
          if [ ! -d "$FIRMWARE_DIR" ] || [ -z "$(ls $FIRMWARE_DIR/*.sysupgrade.bin 2>/dev/null)" ]; then
            echo "ERROR: ç¼–è¯‘å¤±è´¥ï¼æœ€å300è¡Œæ—¥å¿—ï¼š"
            cat build.log | tail -300
            exit 1
          fi

      - name: 8. æ‰“åŒ…å¹¶ä¸Šä¼ äº§ç‰©
        run: |
          cd $FIRMWARE_DIST
          mkdir -p output
          cp bin/targets/$TARGET_PLATFORM/$TARGET_SUBPLATFORM/*.sysupgrade.bin output/
          cp bin/targets/$TARGET_PLATFORM/$TARGET_SUBPLATFORM/*.factory.img output/
          cp .config output/final_config.config
          cp build.log output/build_log.txt

      - name: 9. ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: istoreos-xgp-firmware
          path: ${{ env.FIRMWARE_DIST }}/output/
          retention-days: 30
