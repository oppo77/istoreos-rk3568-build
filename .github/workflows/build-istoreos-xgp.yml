name: Build iStoreOS for XGP with 5G Support

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-istoreos-xgp.yml'
      - 'xgp-5g.config'  # 监控根目录的配置文件

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 480

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 初始化编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev lib32gcc-s1 \
            libc6-dev-i386 libelf-dev libglib2.0-dev xmlto qemu-utils upx-ucl liblzma-dev file wget curl
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: 克隆iStoreOS源码
        run: |
          git clone --depth=1 https://github.com/istoreos/istoreos.git istoreos
          cd istoreos
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 集成5G-Modem-Support
        run: |
          cd istoreos
          rm -rf package/feeds/packages/quectel-MHI package/feeds/packages/qmi-utils package/feeds/packages/wwan
          git clone --depth=1 https://github.com/Siriling/5G-Modem-Support.git package/5G-Modem-Support
          ./scripts/feeds install -a -p 5G-Modem-Support

      - name: 加载配置文件（带详细调试）
        run: |
          # 打印仓库根目录路径（关键！确认文件存放位置）
          echo "当前仓库根目录路径：$GITHUB_WORKSPACE"
          
          # 列出根目录所有文件，确认xgp-5g.config存在
          echo "仓库根目录文件列表："
          ls -la $GITHUB_WORKSPACE
          
          # 检查配置文件是否存在
          CONFIG_FILE="$GITHUB_WORKSPACE/xgp-5g.config"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "❌ 错误：配置文件 $CONFIG_FILE 不存在！"
            exit 1
          else
            echo "✅ 找到配置文件：$CONFIG_FILE"
          fi
          
          # 复制配置文件到编译目录
          cd istoreos
          cp "$CONFIG_FILE" .config
          make defconfig

      - name: 编译固件（控制日志大小）
        run: |
          cd istoreos
          export BUILD_LOG=build.log
          (make -j$(nproc) V=s 2>&1 | tee $BUILD_LOG) || (tail -n 500 $BUILD_LOG && exit 1)
          gzip $BUILD_LOG

      - name: 收集输出文件
        run: |
          mkdir -p output
          cp istoreos/bin/targets/*/*/*.img.gz output/
          cp istoreos/bin/targets/*/*/*.tar.gz output/
          cp istoreos/build.log.gz output/
          ls -lh output/

      - name: 上传编译结果
        uses: actions/upload-artifact@v4
        with:
          name: istoreos-xgp-5g-firmware
          path: output/
          retention-days: 7
