name: 编译iStoreOS（支持WIFI自启+5G模组）
on:
  push:
    branches: [ main ]
    paths:
      - 'xgp.config'          # 监听xgp.config变更触发编译
      - 'device-tree/**'
      - 'custom-scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:  # 支持手动触发

jobs:
  compile:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential git-core libncurses5-dev libssl-dev flex bison gawk \
            make gettext wget unzip zlib1g-dev libbz2-dev liblzma-dev libsqlite3-dev \
            libxml2-dev libxslt1-dev xsltproc python3 python3-pip python3-setuptools \
            perl patchutils curl rsync bc time openssh-client

      - name: 拉取iStoreOS源码
        run: |
          git clone --depth 1 https://github.com/istoreos/istoreos.git istoreos-src
          cd istoreos-src
          git checkout main  # 或指定稳定版本（如v23.05）

      - name: 替换配置文件（使用xgp.config）
        run: |
          # 复制xgp.config到源码根目录（保持源码内仍为.config文件名，避免编译兼容性问题）
          cp xgp.config istoreos-src/.config
          # 复制设备树到对应目录（rockchip armv8架构路径）
          cp device-tree/rk3568-xiguapi-v3.dts istoreos-src/target/linux/rockchip/dts/armv8/
          # 复制WIFI自启脚本到uci-defaults（开机自动执行）
          mkdir -p istoreos-src/package/base-files/files/etc/uci-defaults/
          cp custom-scripts/99-wifi-autostart istoreos-src/package/base-files/files/etc/uci-defaults/

      - name: 生成编译配置（基于xgp.config）
        run: |
          cd istoreos-src
          make defconfig  # 此时会读取已复制的.config（即原xgp.config），无需额外参数

      - name: 编译固件
        run: |
          cd istoreos-src
          make -j$(nproc) V=s  # V=s输出详细日志，nproc自动适配CPU核心数
        env:
          FORCE_UNSAFE_CONFIGURE: 1  # 规避权限警告

      - name: 收集编译产物
        run: |
          mkdir -p firmware-output
          cp istoreos-src/bin/targets/rockchip/armv8/*.img.gz firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.bin firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.manifest firmware-output/

      - name: 上传产物到GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.sha }}
          files: firmware-output/*
          body: "自动编译产物：支持开机自启WIFI、5G模组功能（设备：rk3568-xiguapi-v3，配置文件：xgp.config）"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
