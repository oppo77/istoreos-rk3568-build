name: ç¼–è¯‘ iStoreOS å›ºä»¶ï¼ˆRK3568 + 5Gè‡ªåŠ¨å¯åŠ¨é›†æˆï¼‰

env:
  SOURCE_REPO: "https://github.com/oppo77/istoreos-rk3568-build.git"
  CONFIG_URL: "https://raw.githubusercontent.com/oppo77/istoreos-rk3568-build/refs/heads/main/xgp.config"
  FIRMWARE_DIR: "./istoreos/bin/targets/rockchip/armv8"
  CCACHE_DIR: "./.ccache"
  LOG_DIR: "./build-logs"

on:
  workflow_dispatch:
    inputs:
      wifi_2g_ssid:
        description: "2.4G WiFiåç§°"
        required: true
        default: "iStoreOS-2.4G"
      wifi_2g_pass:
        description: "2.4G WiFiå¯†ç ï¼ˆ8-63ä½ï¼‰"
        required: true
        default: "12345678"
      wifi_5g_ssid:
        description: "5G WiFiåç§°"
        required: true
        default: "iStoreOS-5G"
      wifi_5g_pass:
        description: "5G WiFiå¯†ç ï¼ˆ8-63ä½ï¼‰"
        required: true
        default: "12345678"
      apn_5g:
        description: "5Gæ¨¡å—APN"
        required: true
        default: "cmnet"

jobs:
  build-istoreos:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: 1. é¢„å…ˆåˆ›å»ºæ—¥å¿—ç›®å½•
        run: |
          mkdir -p ${{ env.LOG_DIR }}
          echo "æ—¥å¿—ç›®å½•: $(pwd)/${{ env.LOG_DIR }}" > ${{ env.LOG_DIR }}/start.log
          echo "âœ… æ—¥å¿—ç›®å½•é¢„å…ˆåˆ›å»ºå®Œæˆ"
      
      - name: 2. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 3. éªŒè¯ç›®å½•ç»“æž„
        run: |
          echo "å½“å‰ç›®å½•ç»“æž„:"
          ls -la
          echo "custom-files ç›®å½•ç»“æž„:"
          if [ -d "custom-files" ]; then
            find custom-files -type f
          else
            echo "âŒ custom-files ç›®å½•ä¸å­˜åœ¨ï¼"
            # åˆ›å»ºåŸºç¡€ç›®å½•ç»“æž„
            mkdir -p custom-files/{usr/bin,etc/{init.d,hotplug.d/usb,config}}
            echo "âœ… å·²åˆ›å»ºåŸºç¡€ç›®å½•ç»“æž„"
          fi
        working-directory: ./

      - name: 4. åˆå§‹åŒ–ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            /var/cache/apt/archives
            ./dl
          key: "istoreos-${{ runner.os }}-build-cache-${{ github.sha }}"
          restore-keys: |
            istoreos-${{ runner.os }}-build-cache-

      - name: 5. å¿«é€Ÿæ¸…ç†ç£ç›˜
        run: |
          df -h /
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h /

      - name: 6. å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update -y
          DEPS="ccache git build-essential libncurses5-dev libssl-dev \
            flex bison make gcc g++ gettext python3 python3-pip \
            unzip wget curl file qemu-utils libtool axel rsync"
          sudo apt-get install -y $DEPS
          
          sudo /usr/sbin/update-ccache-symlinks
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          ccache -M 5G
          ccache -s

      - name: 7. å…‹éš†iStoreOSæºç 
        run: |
          if [ ! -d "istoreos/.git" ]; then
            echo "ðŸš€ å…‹éš†iStoreOSæºç åº“..."
            git clone --depth 1 --single-branch ${{ env.SOURCE_REPO }} istoreos
            cd istoreos
            git checkout refs/heads/main
          else
            echo "ðŸ“¥ æ›´æ–°iStoreOSæºç åº“..."
            cd istoreos
            git pull --depth 1
          fi
          
          # éªŒè¯æºç ç»“æž„
          echo "iStoreOSç›®å½•ç»“æž„:"
          ls -la
          if [ ! -f "Makefile" ]; then
            echo "âŒ iStoreOSæºç ä¸å®Œæ•´ï¼Œç¼ºå°‘Makefile"
            exit 1
          fi

      - name: 8. é›†æˆ5Gè‡ªåŠ¨å¯åŠ¨å’ŒWiFié…ç½®
        run: |
          cd istoreos
          
          # åˆ›å»ºç›®æ ‡ç›®å½•ç»“æž„
          mkdir -p files/usr/bin files/etc/init.d files/etc/hotplug.d/usb files/etc/config
          
          # æ£€æŸ¥custom-filesæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™åˆ›å»ºåŸºç¡€æ–‡ä»¶
          if [ ! -f "../custom-files/usr/bin/5g-auto-start.sh" ]; then
            echo "âš ï¸  è‡ªå®šä¹‰æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºåŸºç¡€ç‰ˆæœ¬..."
            
            # åˆ›å»ºåŸºç¡€5Gå¯åŠ¨è„šæœ¬
            cat > files/usr/bin/5g-auto-start.sh << 'EOF'
#!/bin/bash
echo "5Gè‡ªåŠ¨å¯åŠ¨è„šæœ¬å ä½ç¬¦ - è¯·é…ç½®å®Œæ•´çš„custom-filesç›®å½•"
echo "WiFi SSID: ${{ github.event.inputs.wifi_2g_ssid }} / ${{ github.event.inputs.wifi_5g_ssid }}"
EOF
            chmod +x files/usr/bin/5g-auto-start.sh
            
            # åˆ›å»ºåŸºç¡€initè„šæœ¬
            cat > files/etc/init.d/5g-auto << 'EOF'
#!/bin/sh /etc/rc.common
START=99
start() { echo "5GæœåŠ¡å¯åŠ¨"; }
stop() { echo "5GæœåŠ¡åœæ­¢"; }
EOF
            chmod +x files/etc/init.d/5g-auto
            
          else
            # å¤åˆ¶çŽ°æœ‰çš„è‡ªå®šä¹‰æ–‡ä»¶
            cp ../custom-files/usr/bin/5g-auto-start.sh files/usr/bin/
            chmod +x files/usr/bin/5g-auto-start.sh
            
            cp ../custom-files/etc/init.d/5g-auto files/etc/init.d/
            chmod +x files/etc/init.d/5g-auto
            
            if [ -f "../custom-files/etc/hotplug.d/usb/30-5g-modem" ]; then
              cp ../custom-files/etc/hotplug.d/usb/30-5g-modem files/etc/hotplug.d/usb/
              chmod +x files/etc/hotplug.d/usb/30-5g-modem
            fi
          fi
          
          # åˆ›å»ºWiFié…ç½®ï¼ˆæ— è®ºcustom-filesæ˜¯å¦å­˜åœ¨ï¼‰
          cat > files/etc/config/wireless << EOF
config wifi-device 'radio0'
    option type 'mac80211'
    option path 'platform/soc/fe300000.pcie/pci0000:00/0000:00:00.0/0000:01:00.0'
    option channel '11'
    option band '2g'
    option htmode 'HT20'
    option country 'CN'
    option disabled '0'

config wifi-iface 'default_radio0'
    option device 'radio0'
    option network 'lan'
    option mode 'ap'
    option ssid '${{ github.event.inputs.wifi_2g_ssid }}'
    option encryption 'psk2'
    option key '${{ github.event.inputs.wifi_2g_pass }}'

config wifi-device 'radio1'
    option type 'mac80211'
    option path 'platform/soc/fe300000.pcie/pci0000:00/0000:00:01.0/0000:02:00.0'
    option channel '36'
    option band '5g'
    option htmode 'HE80'
    option country 'CN'
    option disabled '0'

config wifi-iface 'default_radio1'
    option device 'radio1'
    option network 'lan'
    option mode 'ap'
    option ssid '${{ github.event.inputs.wifi_5g_ssid }}'
    option encryption 'psk2'
    option key '${{ github.event.inputs.wifi_5g_pass }}'
EOF
          
          echo "âœ… 5Gè‡ªåŠ¨å¯åŠ¨å’ŒWiFié…ç½®é›†æˆå®Œæˆ"

      - name: 9. ä¸‹è½½iStoreOSé…ç½®æ–‡ä»¶
        run: |
          cd istoreos
          echo "ä¸‹è½½é…ç½®æ–‡ä»¶: ${{ env.CONFIG_URL }}"
          wget -q -O .config ${{ env.CONFIG_URL }} || curl -s -o .config ${{ env.CONFIG_URL }}
          
          if [ ! -f ".config" ]; then
            echo "âŒ é…ç½®æ–‡ä»¶ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          # éªŒè¯é…ç½®æ–‡ä»¶åŸºæœ¬å†…å®¹
          if grep -q "CONFIG_TARGET_rockchip" .config; then
            echo "âœ… iStoreOSé…ç½®æ–‡ä»¶ä¸‹è½½å’ŒéªŒè¯å®Œæˆ"
          else
            echo "âŒ é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®"
            exit 1
          fi

      - name: 10. åº”ç”¨ç¼–è¯‘ä¼˜åŒ–é…ç½®
        run: |
          cd istoreos
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          echo "âœ… ç¼–è¯‘ä¼˜åŒ–é…ç½®åº”ç”¨å®Œæˆ"

      - name: 11. é…ç½®ä¸‹è½½åŠ é€Ÿ
        run: |
          cd istoreos
          if ! grep -q "WGET_CMD.*axel" include/download.mk; then
            sed -i 's/^WGET_CMD.*/WGET_CMD = axel -n 16 -a -o $(DL_DIR)\/\$(FILE) $(URL)/' include/download.mk
          fi
          echo "DOWNLOAD_TIMEOUT=1800" >> include/download.mk
          echo "âœ… ä¸‹è½½åŠ é€Ÿé…ç½®å®Œæˆ"

      - name: 12. é¢„ä¸‹è½½èµ„æºæ–‡ä»¶
        run: |
          cd istoreos
          export FORCE_UNSAFE_CONFIGURE=1
          echo "ðŸ“¥ å¼€å§‹é¢„ä¸‹è½½èµ„æºæ–‡ä»¶..."
          make download -j$(nproc) 2>&1 | tee ${{ env.LOG_DIR }}/download.log || make download -j2 2>&1 | tee -a ${{ env.LOG_DIR }}/download.log
          echo "âœ… èµ„æºæ–‡ä»¶ä¸‹è½½å®Œæˆ"

      - name: 13. é…ç½®ç¼–è¯‘çŽ¯å¢ƒ
        run: |
          cd istoreos
          export FORCE_UNSAFE_CONFIGURE=1
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          ccache -z
          
          CPU_CORES=$(nproc)
          MEMORY_GB=$(free -g | awk 'NR==2{print $2}')
          if [ $MEMORY_GB -ge 16 ]; then
            JOB_COUNT=$((CPU_CORES + 2))
          elif [ $MEMORY_GB -ge 8 ]; then
            JOB_COUNT=$CPU_CORES
          else
            JOB_COUNT=$((CPU_CORES / 2))
          fi
          echo "JOB_COUNT=$JOB_COUNT" >> $GITHUB_ENV
          echo "ä½¿ç”¨ $JOB_COUNT ä¸ªçº¿ç¨‹ç¼–è¯‘iStoreOSï¼ˆCPU: $CPU_CORES, å†…å­˜: ${MEMORY_GB}GBï¼‰"

      - name: 14. ç¼–è¯‘iStoreOSå›ºä»¶
        run: |
          cd istoreos
          export FORCE_UNSAFE_CONFIGURE=1
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          
          echo "ðŸ—ï¸ å¼€å§‹ç¼–è¯‘iStoreOSå›ºä»¶..."
          # å…ˆåšdefconfigç¡®ä¿é…ç½®æ­£ç¡®
          make defconfig 2>&1 | tee ${{ env.LOG_DIR }}/defconfig.log
          
          # ä¸»è¦ç¼–è¯‘è¿‡ç¨‹
          make -j$JOB_COUNT V=sc 2>&1 | tee ${{ env.LOG_DIR }}/compile.log
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æžœ
          if [ ! -d "${{ env.FIRMWARE_DIR }}" ] || ! ls "${{ env.FIRMWARE_DIR }}"/*.img* >/dev/null 2>&1; then
            echo "âŒ iStoreOSå›ºä»¶ç”Ÿæˆå¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            make -j1 V=s 2>&1 | tee -a ${{ env.LOG_DIR }}/compile.log
            
            # å¦‚æžœå•çº¿ç¨‹ä¹Ÿå¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯
            if [ ! -d "${{ env.FIRMWARE_DIR }}" ]; then
              echo "âŒ ç¼–è¯‘å½»åº•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
              exit 1
            fi
          fi

      - name: 15. æ˜¾ç¤ºç¼–è¯‘ç»Ÿè®¡
        run: |
          cd istoreos
          ccache -s 2>&1 | tee ${{ env.LOG_DIR }}/ccache.log
          echo "iStoreOSç¼–è¯‘å®Œæˆ"

      - name: 16. éªŒè¯iStoreOSè¾“å‡ºæ–‡ä»¶
        run: |
          cd istoreos
          echo "ðŸ“ iStoreOSå›ºä»¶è¾“å‡ºç›®å½•:" 2>&1 | tee ${{ env.LOG_DIR }}/verify.log
          if [ -d "${{ env.FIRMWARE_DIR }}" ]; then
            ls -la "${{ env.FIRMWARE_DIR }}/" 2>&1 | tee -a ${{ env.LOG_DIR }}/verify.log
            echo "âœ… iStoreOSå›ºä»¶ç”ŸæˆæˆåŠŸ" 2>&1 | tee -a ${{ env.LOG_DIR }}/verify.log
          else
            echo "âŒ iStoreOSå›ºä»¶ç›®å½•ä¸å­˜åœ¨" 2>&1 | tee -a ${{ env.LOG_DIR }}/verify.log
            find ./bin -name "*.img*" -type f | head -10 2>&1 | tee -a ${{ env.LOG_DIR }}/verify.log
            exit 1
          fi

      - name: 17. æ•´ç†iStoreOSäº§ç‰©
        run: |
          mkdir -p istoreos-firmware
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          if [ -d "istoreos/${{ env.FIRMWARE_DIR }}" ]; then
            cp "istoreos/${{ env.FIRMWARE_DIR }}"/*.img* istoreos-firmware/ 2>/dev/null || true
            cp "istoreos/${{ env.FIRMWARE_DIR }}"/*.manifest istoreos-firmware/ 2>/dev/null || true
          else
            find ./istoreos/bin -name "*.img*" -exec cp {} istoreos-firmware/ \; 2>/dev/null || true
          fi
          
          cd istoreos-firmware
          # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
          for file in *.img*; do
            [ -e "$file" ] && md5sum "$file" >> MD5æ ¡éªŒå€¼.txt
          done
          
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-8)
          echo "======================================" > å›ºä»¶ä¿¡æ¯.txt
          echo "           iStoreOSå›ºä»¶ä¿¡æ¯            " >> å›ºä»¶ä¿¡æ¯.txt
          echo "======================================" >> å›ºä»¶ä¿¡æ¯.txt
          echo "è®¾å¤‡ï¼šRK3568 (XGP)" >> å›ºä»¶ä¿¡æ¯.txt
          echo "ç¼–è¯‘æ—¶é—´ï¼š$(date +"%Y-%m-%d %H:%M:%S")" >> å›ºä»¶ä¿¡æ¯.txt
          echo "Gitæäº¤ï¼š$SHORT_SHA" >> å›ºä»¶ä¿¡æ¯.txt
          echo "ç‰ˆæœ¬ï¼šiStoreOS + 5Gè‡ªåŠ¨å¯åŠ¨" >> å›ºä»¶ä¿¡æ¯.txt
          echo "ç‰¹æ€§ï¼šåˆ·æœºåŽè‡ªåŠ¨å¯åŠ¨5Gå’ŒWiFi" >> å›ºä»¶ä¿¡æ¯.txt
          echo "2.4G WiFiï¼š${{ github.event.inputs.wifi_2g_ssid }}" >> å›ºä»¶ä¿¡æ¯.txt
          echo "5G WiFiï¼š${{ github.event.inputs.wifi_5g_ssid }}" >> å›ºä»¶ä¿¡æ¯.txt
          echo "5G APNï¼š${{ github.event.inputs.apn_5g }}" >> å›ºä»¶ä¿¡æ¯.txt
          echo "======================================" >> å›ºä»¶ä¿¡æ¯.txt
          [ -f "MD5æ ¡éªŒå€¼.txt" ] && cat MD5æ ¡éªŒå€¼.txt >> å›ºä»¶ä¿¡æ¯.txt

      - name: 18. ä¸Šä¼ iStoreOSå›ºä»¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: "iStoreOS-RK3568-5Gè‡ªåŠ¨ç‰ˆ-${{ github.run_number }}-$(echo ${{ github.sha }} | cut -c1-8)"
          path: istoreos-firmware/
          retention-days: 30
          if-no-files-found: error

      - name: 19. ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨å¹¶ä¸Šä¼ 
        if: always()
        run: |
          mkdir -p ${{ env.LOG_DIR }}
          echo "ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨å®Œæˆ" > ${{ env.LOG_DIR }}/ensure.log
          echo "æ—¥å¿—ç›®å½•å†…å®¹:"
          ls -la ${{ env.LOG_DIR }} || echo "æ—¥å¿—ç›®å½•ä¸ºç©º"

      - name: 20. ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "iStoreOSç¼–è¯‘æ—¥å¿—-${{ github.run_number }}"
          path: ${{ env.LOG_DIR }}/
          retention-days: 15
          if-no-files-found: warn
