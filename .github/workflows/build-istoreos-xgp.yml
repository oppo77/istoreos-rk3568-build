name: 编译 iStoreOS 固件（RK3568 + 5G自动启动集成）

env:
  SOURCE_REPO: "https://github.com/oppo77/istoreos-rk3568-build.git"
  CONFIG_URL: "https://raw.githubusercontent.com/oppo77/istoreos-rk3568-build/refs/heads/main/xgp.config"
  FIRMWARE_DIR: "./istoreos/bin/targets/rockchip/armv8"
  CCACHE_DIR: "./.ccache"
  LOG_DIR: "./build-logs"
  BUILD_VERSION: "v1.0.0"

on:
  workflow_dispatch:
    inputs:
      wifi_2g_ssid:
        description: "2.4G WiFi名称"
        required: true
        default: "XGP-2.4G-Hotspot"
      wifi_2g_pass:
        description: "2.4G WiFi密码（8-63位）"
        required: true
        default: "xgp123456"
      wifi_5g_ssid:
        description: "5G WiFi名称"
        required: true
        default: "XGP-5G-Hotspot"
      wifi_5g_pass:
        description: "5G WiFi密码（8-63位）"
        required: true
        default: "xgp123456"
      apn_5g:
        description: "5G模块APN"
        required: true
        default: "cmnet"
      enable_port_forwarding:
        description: "是否启用网口转发"
        required: true
        type: boolean
        default: true

jobs:
  build-istoreos:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
      - name: 1. 预先创建日志目录
        run: |
          mkdir -p ${{ env.LOG_DIR }}
          echo "日志目录: $(pwd)/${{ env.LOG_DIR }}" > ${{ env.LOG_DIR }}/start.log
          echo "✅ 日志目录预先创建完成"
      
      - name: 2. 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 3. 验证目录结构
        run: |
          echo "当前目录结构:"
          ls -la
          echo "custom-files 目录结构:"
          if [ -d "custom-files" ]; then
            find custom-files -type f
          else
            echo "❌ custom-files 目录不存在！"
            mkdir -p custom-files/{etc/init.d,config}
            echo "✅ 已创建基础目录结构"
          fi

      - name: 4. 初始化缓存
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            /var/cache/apt/archives
            ./dl
          key: "istoreos-${{ runner.os }}-build-cache-${{ github.sha }}"
          restore-keys: |
            istoreos-${{ runner.os }}-build-cache-

      - name: 5. 快速清理磁盘
        run: |
          df -h /
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h /

      - name: 6. 安装编译依赖
        run: |
          sudo apt-get update -y
          DEPS="ccache git build-essential libncurses5-dev libssl-dev flex bison make gcc g++ gettext python3 python3-pip unzip wget curl file qemu-utils libtool axel rsync"
          sudo apt-get install -y $DEPS
          
          sudo /usr/sbin/update-ccache-symlinks
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          ccache -M 5G
          ccache -s

      - name: 7. 克隆iStoreOS源码
        run: |
          if [ ! -d "istoreos/.git" ]; then
            echo "🚀 克隆iStoreOS源码库..."
            git clone --depth 1 --single-branch ${{ env.SOURCE_REPO }} istoreos
            cd istoreos
            git checkout refs/heads/main
          else
            echo "📥 更新iStoreOS源码库..."
            cd istoreos
            git pull --depth 1
          fi
          
          echo "iStoreOS目录结构:"
          ls -la
          if [ ! -f "Makefile" ]; then
            echo "❌ iStoreOS源码不完整，缺少Makefile"
            exit 1
          fi

      - name: 8. 下载iStoreOS配置文件
        run: |
          cd istoreos
          echo "下载配置文件: ${{ env.CONFIG_URL }}"
          wget -q -O .config ${{ env.CONFIG_URL }} || curl -s -o .config ${{ env.CONFIG_URL }}
          
          if [ ! -f ".config" ]; then
            echo "❌ 配置文件下载失败"
            exit 1
          fi
          
          if grep -q "CONFIG_TARGET_rockchip" .config; then
            echo "✅ iStoreOS配置文件下载和验证完成"
          else
            echo "❌ 配置文件格式不正确"
            exit 1
          fi

      - name: 9. 应用编译优化配置
        run: |
          cd istoreos
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=8192" >> .config
          echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_EXT4FS_LABEL=\"rootfs\"" >> .config
          echo "✅ 编译优化配置应用完成"

      - name: 10. 配置下载加速
        run: |
          cd istoreos
          if ! grep -q "WGET_CMD.*axel" include/download.mk; then
            sed -i 's/^WGET_CMD.*/WGET_CMD = axel -n 16 -a -o $(DL_DIR)\/\$(FILE) $(URL)/' include/download.mk
          fi
          echo "DOWNLOAD_TIMEOUT=1800" >> include/download.mk
          echo "✅ 下载加速配置完成"

      - name: 11. 集成5G自动启动和WiFi配置
        run: |
          cd istoreos
          mkdir -p files/etc/init.d files/etc/config
          
          # 创建5G自动启动脚本（仅启动5G模块，不包含WiFi设置）
          cat > files/etc/init.d/5g-auto << 'EOF'
#!/bin/sh /etc/rc.common
START=99
STOP=10
start() {
    echo "🚀 启动5G自动启动服务"
    # 5G模块启动命令
    if [ -e /dev/cdc-wdm0 ]; then
        mbimcli -d /dev/cdc-wdm0 --set-operating-mode=online
        sleep 5
        echo "5G模块已启动"
    else
        echo "❌ 5G模块设备不存在，无法启动"
    fi
}
stop() {
    echo "🛑 停止5G自动启动服务"
    if [ -e /dev/cdc-wdm0 ]; then
        mbimcli -d /dev/cdc-wdm0 --set-operating-mode=offline
        echo "5G模块已停止"
    fi
}
EOF
          chmod +x files/etc/init.d/5g-auto
          
          # 创建WiFi配置（直接使用用户输入的SSID和密码）
          cat > files/etc/config/wireless << "ENDOFFILE"
config wifi-device 'radio0'
    option type 'mac80211'
    option path 'platform/soc/fe300000.pcie/pci0000:00/0000:00:00.0/0000:01:00.0'
    option channel '11'
    option band '2g'
    option htmode 'HT20'
    option country 'CN'
    option disabled '0'

config wifi-iface 'default_radio0'
    option device 'radio0'
    option network 'lan'
    option mode 'ap'
    option ssid '${WIFI_2G_SSID}'
    option encryption 'psk2'
    option key '${WIFI_2G_PASS}'

config wifi-device 'radio1'
    option type 'mac80211'
    option path 'platform/soc/fe300000.pcie/pci0000:00/0000:00:01.0/0000:02:00.0'
    option channel '36'
    option band '5g'
    option htmode 'HE80'
    option country 'CN'
    option disabled '0'

config wifi-iface 'default_radio1'
    option device 'radio1'
    option network 'lan'
    option mode 'ap'
    option ssid '${WIFI_5G_SSID}'
    option encryption 'psk2'
    option key '${WIFI_5G_PASS}'
ENDOFFILE
          
          # 替换占位符
          sed -i "s/\${WIFI_2G_SSID}/${{ github.event.inputs.wifi_2g_ssid }}/" files/etc/config/wireless
          sed -i "s/\${WIFI_5G_SSID}/${{ github.event.inputs.wifi_5g_ssid }}/" files/etc/config/wireless
          sed -i "s/\${WIFI_2G_PASS}/${{ github.event.inputs.wifi_2g_pass }}/" files/etc/config/wireless
          sed -i "s/\${WIFI_5G_PASS}/${{ github.event.inputs.wifi_5g_pass }}/" files/etc/config/wireless
          
          echo "✅ 5G自动启动和WiFi配置集成完成"

      - name: 12. 预下载资源文件
        run: |
          cd istoreos
          export FORCE_UNSAFE_CONFIGURE=1
          echo "📥 开始预下载资源文件..."
          make download -j$(nproc) 2>&1 | tee ${{ env.LOG_DIR }}/download.log || make download -j2 2>&1 | tee -a ${{ env.LOG_DIR }}/download.log
          echo "✅ 资源文件下载完成"

      - name: 13. 配置编译环境
        run: |
          cd istoreos
          export FORCE_UNSAFE_CONFIGURE=1
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          ccache -z
          
          CPU_CORES=$(nproc)
          MEMORY_GB=$(free -g | awk 'NR==2{print $2}')
          if [ $MEMORY_GB -ge 16 ]; then
            JOB_COUNT=$((CPU_CORES + 2))
          elif [ $MEMORY_GB -ge 8 ]; then
            JOB_COUNT=$CPU_CORES
          else
            JOB_COUNT=$((CPU_CORES / 2))
          fi
          echo "JOB_COUNT=$JOB_COUNT" >> $GITHUB_ENV
          echo "使用 $JOB_COUNT 个线程编译iStoreOS（CPU: $CPU_CORES, 内存: ${MEMORY_GB}GB）"

      - name: 14. 编译iStoreOS固件
        run: |
          cd istoreos
          export FORCE_UNSAFE_CONFIGURE=1
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          
          echo "🏗️ 开始编译iStoreOS固件..."
          make defconfig 2>&1 | tee ${{ env.LOG_DIR }}/defconfig.log
          make -j$JOB_COUNT V=sc 2>&1 | tee ${{ env.LOG_DIR }}/compile.log
          
          if [ ! -d "${{ env.FIRMWARE_DIR }}" ] || ! ls "${{ env.FIRMWARE_DIR }}"/*.img* >/dev/null 2>&1; then
            echo "❌ iStoreOS固件生成失败，尝试单线程编译..."
            make -j1 V=s 2>&1 | tee -a ${{ env.LOG_DIR }}/compile.log
            if [ ! -d "${{ env.FIRMWARE_DIR }}" ]; then
              echo "❌ 编译彻底失败，请检查日志"
              exit 1
            fi
          fi

      - name: 15. 显示编译统计
        run: |
          cd istoreos
          ccache -s 2>&1 | tee ${{ env.LOG_DIR }}/ccache.log
          echo "iStoreOS编译完成"

      - name: 16. 验证iStoreOS输出文件
        run: |
          cd istoreos
          echo "📁 iStoreOS固件输出目录:" 2>&1 | tee ${{ env.LOG_DIR }}/verify.log
          if [ -d "${{ env.FIRMWARE_DIR }}" ]; then
            ls -la "${{ env.FIRMWARE_DIR }}/" 2>&1 | tee -a ${{ env.LOG_DIR }}/verify.log
            echo "✅ iStoreOS固件生成成功" 2>&1 | tee -a ${{ env.LOG_DIR }}/verify.log
          else
            echo "❌ iStoreOS固件目录不存在" 2>&1 | tee -a ${{ env.LOG_DIR }}/verify.log
            find ./bin -name "*.img*" -type f | head -10 2>&1 | tee -a ${{ env.LOG_DIR }}/verify.log
            exit 1
          fi

      - name: 17. 整理iStoreOS产物
        run: |
          mkdir -p istoreos-firmware
          
          if [ -d "istoreos/${{ env.FIRMWARE_DIR }}" ]; then
            cp "istoreos/${{ env.FIRMWARE_DIR }}"/*.img* istoreos-firmware/ 2>/dev/null || true
            cp "istoreos/${{ env.FIRMWARE_DIR }}"/*.manifest istoreos-firmware/ 2>/dev/null || true
          else
            find ./istoreos/bin -name "*.img*" -exec cp {} istoreos-firmware/ \; 2>/dev/null || true
          fi
          
          cd istoreos-firmware
          for file in *.img*; do
            [ -e "$file" ] && md5sum "$file" >> MD5校验值.txt
          done
          
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-8)
          cat > 固件信息.txt << "EOF"
======================================
           iStoreOS固件信息            
======================================
设备：RK3568 (XGP)
编译时间：$(date +"%Y-%m-%d %H:%M:%S")
Git提交：$SHORT_SHA
版本：iStoreOS + 5G自动启动
特性：刷机后自动启动5G和WiFi
2.4G WiFi：${{ github.event.inputs.wifi_2g_ssid }}
5G WiFi：${{ github.event.inputs.wifi_5g_ssid }}
5G APN：${{ github.event.inputs.apn_5g }}
启用网口转发：${{ github.event.inputs.enable_port_forwarding }}
======================================
EOF
          if [ -f "MD5校验值.txt" ]; then
            cat MD5校验值.txt >> 固件信息.txt
          fi

      - name: 18. 上传iStoreOS固件产物
        uses: actions/upload-artifact@v4
        with:
          name: "iStoreOS-RK3568-5G自动版-${{ github.run_number }}-$(echo ${{ github.sha }} | cut -c1-8)"
          path: istoreos-firmware/
          retention-days: 30
          if-no-files-found: error

      - name: 19. 确保日志目录存在并上传
        if: always()
        run: |
          mkdir -p ${{ env.LOG_DIR }}
          echo "确保日志目录存在完成" > ${{ env.LOG_DIR }}/ensure.log
          echo "日志目录内容:"
          ls -la ${{ env.LOG_DIR }} || echo "日志目录为空"

      - name: 20. 上传编译日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "iStoreOS编译日志-${{ github.run_number }}"
          path: ${{ env.LOG_DIR }}/
          retention-days: 15
          if-no-files-found: warn
