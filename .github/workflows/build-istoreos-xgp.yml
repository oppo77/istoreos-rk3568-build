name: 编译iStoreOS-XGP（最新版+QModem5G）

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-istoreos-xgp.yml'
      - 'xgp-qmodem.config'
      - 'files/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TARGET_PLATFORM: rockchip
      TARGET_SUBPLATFORM: rk35xx
      FIRMWARE_DIST: istoreos

    steps:
      - name: 1. 拉取仓库代码
        uses: actions/checkout@v4

      - name: 2. 更换源+安装基础依赖
        run: |
          # 更换阿里云源，确保包完整性
          sudo sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list
          sudo sed -i s@/security.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list
          sudo apt clean && sudo apt update -y

          # 安装已知的核心依赖（覆盖基础和最新版需求）
          sudo apt install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libncursesw5-dev libssl-dev libelf-dev \
            libtool autoconf automake pkg-config perl python3 python3-pip \
            python3-setuptools python3-yaml rsync subversion unzip wget \
            zlib1g-dev quilt libc6-dev-i386 u-boot-tools dosfstools mtools parted \
            dwarves bc liblz4-tool meson ninja-build cmake \
            # 新增：针对最新版固件打包和驱动编译的依赖
            squashfs-tools patchelf libseccomp-dev device-tree-compiler

      - name: 3. 克隆iStoreOS最新源码
        run: |
          git clone https://github.com/istoreos/istoreos.git $FIRMWARE_DIST
          cd $FIRMWARE_DIST
          git pull
          echo "当前源码commit：$(git rev-parse --short HEAD)"

      - name: 4. 同步软件源（含QModem）
        run: |
          cd $FIRMWARE_DIST
          echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a -f

      - name: 5. 导入配置文件
        run: |
          cd $FIRMWARE_DIST
          CONFIG_URL="https://raw.githubusercontent.com/oppo77/istoreos-rk3568-build/main/xgp-qmodem.config"
          wget --no-check-certificate -O .config "$CONFIG_URL" || exit 1
          make defconfig
          grep -q "CONFIG_TARGET_rockchip=y" .config || exit 1
          grep -q "CONFIG_PACKAGE_luci-app-qmodem=y" .config || exit 1

      - name: 6. 动态检测并补充缺失依赖（核心修复）
        run: |
          cd $FIRMWARE_DIST
          # 第一次执行prereq检查，捕获缺失的工具
          if ! make prereq V=99 2>&1 | tee prereq.log; then
            echo "检测到缺失依赖，尝试自动补充..."
            # 从日志中提取"missing"的工具（如"missing: abc" → 提取abc）
            MISSING_TOOLS=$(grep "missing" prereq.log | awk '{print $2}' | sort | uniq)
            if [ -n "$MISSING_TOOLS" ]; then
              echo "需要补充的依赖：$MISSING_TOOLS"
              # 自动安装缺失的工具（假设包名与工具名一致，特殊情况手动处理）
              sudo apt install -y $MISSING_TOOLS
              # 安装后重试prereq检查
              if ! make prereq V=99; then
                echo "ERROR: 补充依赖后仍失败，请手动检查prereq.log"
                exit 1
              fi
            else
              echo "ERROR: 未识别到具体缺失的依赖，请查看prereq.log"
              exit 1
            fi
          fi

      - name: 7. 编译固件
        run: |
          cd $FIRMWARE_DIST
          make -j1 V=s 2>&1 | tee build.log
          FIRMWARE_DIR="bin/targets/$TARGET_PLATFORM/$TARGET_SUBPLATFORM"
          [ -d "$FIRMWARE_DIR" ] && [ -n "$(ls $FIRMWARE_DIR/*.sysupgrade.bin 2>/dev/null)" ] || {
            cat build.log | tail -500
            exit 1
          }

      - name: 8. 打包产物（含调试日志）
        run: |
          cd $FIRMWARE_DIST
          mkdir -p output
          cp $FIRMWARE_DIR/*.sysupgrade.bin output/
          cp $FIRMWARE_DIR/*.factory.img output/ 2>/dev/null
          cp .config output/final_config.config
          cp build.log output/build_log.txt
          cp prereq.log output/prereq_check.log  # 保存依赖检查日志

      - name: 9. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: istoreos-latest-xgp-firmware
          path: ${{ env.FIRMWARE_DIST }}/output/
          retention-days: 30
