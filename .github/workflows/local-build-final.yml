name: 本地编译iStoreOS-XGP（依赖修复版）

on:
  workflow_dispatch:

jobs:
  local-build:
    runs-on: self-hosted
    env:
      TARGET_PLATFORM: rockchip
      TARGET_SUBPLATFORM: rk35xx
      FIRMWARE_DIST: istoreos
      ISTOREOS_BRANCH: "istoreos-24.10"
      LOCAL_BUILD_DIR: "${{ github.workspace }}/build"
      VENV_PATH: "${LOCAL_BUILD_DIR}/python-venv"
      GITHUB_MIRROR: "https://bgithub.xyz"

    steps:
      - name: 0. 配置GitHub镜像
        run: |
          git config --global url."${{ env.GITHUB_MIRROR }}/".insteadOf "https://github.com/"

      - name: 1. 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 2. 安装系统依赖（补充swig和必备工具）
        run: |
          echo "===== 安装核心系统依赖 ====="
          # 补充 swig（U-Boot必需）和其他缺失工具
          REQUIRED_PACKAGES="build-essential flex bison g++ gawk gcc-multilib \
            gettext git libncurses5-dev libssl-dev libelf-dev python3 python3-pip \
            python3-venv rsync unzip wget zlib1g-dev quilt u-boot-tools squashfs-tools \
            meson ninja-build cmake device-tree-compiler liblz4-tool \
            swig  # 新增：U-Boot依赖的swig工具
            python3-dev python3-setuptools  # 确保Python开发库
            libncursesw5-dev  # 补充ncurses开发库
          "

          for pkg in $REQUIRED_PACKAGES; do
            if ! dpkg -l | grep -q "$pkg"; then
              echo "安装缺失依赖：$pkg"
              sudo apt update -y
              sudo apt install -y "$pkg" || exit 1
            fi
          done

          # 验证swig是否安装
          if ! command -v swig &> /dev/null; then
            echo "ERROR: swig安装失败！"
            exit 1
          fi

      - name: 3. 配置Python虚拟环境（确保pyelftools）
        run: |
          echo "===== 准备虚拟环境 ====="
          mkdir -p "$(dirname ${{ env.VENV_PATH }})"
          rm -rf "${{ env.VENV_PATH }}"  # 彻底清理旧环境
          /usr/bin/python3 -m venv "${{ env.VENV_PATH }}" || exit 1

          # 强制激活并安装pyelftools
          source "${{ env.VENV_PATH }}/bin/activate" || exit 1
          echo "当前Python环境：$(which python3)"
          pip install pyelftools --upgrade || {
            echo "ERROR: pyelftools安装失败！"
            exit 1
          }
          # 验证pyelftools
          if ! python3 -c "import elftools" &> /dev/null; then
            echo "ERROR: 虚拟环境中仍缺少pyelftools！"
            exit 1
          fi
          deactivate

      - name: 4. 克隆iStoreOS源码（确保完整）
        run: |
          mkdir -p ${{ env.LOCAL_BUILD_DIR }}
          cd ${{ env.LOCAL_BUILD_DIR }}
          # 彻底清理旧源码（避免残留问题）
          rm -rf ${{ env.FIRMWARE_DIST }}
          git clone "${{ env.GITHUB_MIRROR }}/istoreos/istoreos.git" ${{ env.FIRMWARE_DIST }} || exit 1
          cd ${{ env.FIRMWARE_DIST }}
          git remote set-url origin "${{ env.GITHUB_MIRROR }}/istoreos/istoreos.git"
          git checkout ${{ env.ISTOREOS_BRANCH }} || exit 1
          git pull || exit 1

      - name: 5. 同步软件源（修复QModem和第三方依赖）
        run: |
          cd ${{ env.LOCAL_BUILD_DIR }}/${{ env.FIRMWARE_DIST }}
          # 替换国内源加速
          sed -i 's#https://downloads.openwrt.org#https://mirrors.ustc.edu.cn/openwrt#g' feeds.conf.default

          # 修复QModem源（确保依赖包存在）
          sed -i '/qmodem/d' feeds.conf.default
          # 使用QModem官方源（若镜像不可用，替换为原地址）
          echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

          # 移除baidupcs-web相关源（避免依赖错误，或替换为有效源）
          sed -i '/baidupcs-web/d' feeds.conf.default
          # 可选：若需要baidupcs-web，添加正确源
          # echo "src-git baidupcs https://github.com/linkease/baidupcs-web.git" >> feeds.conf.default

          # 强制同步所有源（--force更新）
          ./scripts/feeds update -a -f || exit 1
          # 重新安装所有包（确保依赖被拉取）
          ./scripts/feeds install -a -f || exit 1

          # 验证QModem依赖是否存在
          if [ ! -d "package/feeds/qmodem/quectel-CM-5G" ] || [ ! -d "package/feeds/qmodem/quectel-cm" ]; then
            echo "ERROR: QModem依赖包未同步！检查QModem源是否有效"
            exit 1
          fi

      - name: 6. 导入设备配置（简化配置，避免无效依赖）
        run: |
          cd ${{ env.LOCAL_BUILD_DIR }}/${{ env.FIRMWARE_DIST }}
          cp ${{ github.workspace }}/xgp-qmodem.config .config
          # 禁用有依赖问题的包（如baidupcs-web）
          sed -i 's/CONFIG_PACKAGE_luci-app-baidupcs-web=y/# CONFIG_PACKAGE_luci-app-baidupcs-web is not set/' .config
          make defconfig || exit 1

      - name: 7. 编译（确保虚拟环境激活）
        run: |
          cd ${{ env.LOCAL_BUILD_DIR }}/${{ env.FIRMWARE_DIST }}
          # 激活虚拟环境（关键：确保pyelftools可用）
          source "${{ env.VENV_PATH }}/bin/activate" || exit 1
          echo "使用Python环境：$(which python3)"

          CPU_CORES=$(nproc)
          echo "使用 $CPU_CORES 核心编译..."
          # 先运行prereq检查，提前暴露错误
          make prereq || {
            echo "ERROR: 依赖检查失败！"
            exit 1
          }

          # 开始编译（生成build.log后再检查进度）
          make -j$CPU_CORES V=m 2>&1 | tee build.log &
          PID=$!
          # 延迟1分钟再检查进度（等待build.log生成）
          sleep 60
          while kill -0 $PID 2>/dev/null; do
            echo "===== 编译中（$(date +%H:%M:%S)）====="
            grep -E "Compiling|Linking|Installing" build.log | tail -5
            sleep 600
          done
          wait $PID

          deactivate

          # 验证固件
          FIRMWARE_DIR="bin/targets/$TARGET_PLATFORM/$TARGET_SUBPLATFORM"
          if [ ! -d "$FIRMWARE_DIR" ] || [ -z "$(ls $FIRMWARE_DIR/*.sysupgrade.bin 2>/dev/null)" ]; then
            echo "ERROR: 编译失败！最后1000行日志："
            cat build.log | tail -1000
            exit 1
          fi

      - name: 8. 打包产物
        run: |
          LOCAL_OUTPUT="${{ github.workspace }}/local-firmware"
          mkdir -p $LOCAL_OUTPUT
          cp -r ${{ env.LOCAL_BUILD_DIR }}/${{ env.FIRMWARE_DIST }}/bin/targets/$TARGET_PLATFORM/$TARGET_SUBPLATFORM/* $LOCAL_OUTPUT/
          cp ${{ env.LOCAL_BUILD_DIR }}/${{ env.FIRMWARE_DIST }}/build.log $LOCAL_OUTPUT/
          echo "产物路径：$LOCAL_OUTPUT"
