name: 编译iStoreOS固件（rk3568-xiguapi-v3）

# 手动触发（workflow_dispatch）
on:
  workflow_dispatch:
    inputs:
      build_comment:
        description: '编译备注'
        required: false
        default: '手动触发编译rk3568-xiguapi-v3固件'

jobs:
  build:
    runs-on: ubuntu-22.04  # 与本地环境一致
    steps:
      # 1. 拉取源码（含本地修改）
      - name: 拉取iStoreOS源码
        uses: actions/checkout@v4
        with:
          repository: istoreos/istoreos  # 若为私有仓库，替换为你的仓库地址
          fetch-depth: 1
          submodules: 'recursive'

      # 3. 安装编译依赖（与本地步骤一致）
      - name: 安装编译依赖
        run: |
          sudo apt update && sudo apt upgrade -y
          # 基础依赖
          sudo apt-get install -y binutils bzip2 diffutils findutils flex gawk gcc grep coreutils libc6-dev zlib1g-dev make perl python3 rsync subversion unzip 
          # Python依赖
          sudo apt install -y python3-pyelftools python3-setuptools swig python3-dev python3-pip
          # U-Boot与设备树依赖
          sudo apt install -y u-boot-tools device-tree-compiler libfdt-dev
          # 补充依赖
          sudo apt install -y git git-core clang llvm lld ncurses-term libncurses5-dev libncursesw5-dev libssl-dev libelf-dev autoconf automake libtool pkg-config libsqlite3-dev

      # 4. 更新feeds并安装指定包（用户需求）
      - name: 更新feeds并安装依赖包
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          # 安装用户指定feeds包
          ./scripts/feeds install libpam libev attr curl liblzma libnetsnmp luci-theme-argon

      # 5. 加载配置并编译
      - name: 加载配置与编译固件
        run: |
          # 加载配置（处理依赖）
          make defconfig
          # 编译（使用4线程，避免资源耗尽）
          make -j4 V=s  # V=s显示编译日志，便于排查错误

      # 6. 上传编译产物（固件）
      - name: 上传固件产物
        uses: actions/upload-artifact@v4
        with:
          name: istoreos-rk3568-xiguapi-v3
          path: |
            bin/targets/rockchip/armv8/*.img.gz  # 固件文件（根据实际输出调整）
            bin/targets/rockchip/armv8/*.dtb     # 设备树文件
          retention-days: 30  # 产物保留30天
