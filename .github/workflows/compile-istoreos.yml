name: 编译iStoreOS（权限修复+APT源写入）
on:
  workflow_dispatch:
    inputs:
      firmware_version:
        description: '固件版本备注（如v1.0.0）'
        required: false
        default: 'dev-build'

jobs:
  compile:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 阶段1：修复APT源（解决权限+正确写入）
        run: |
          echo "=== 修复APT源写入权限，解决which包缺失 ==="
          # 1. 清理APT缓存（sudo作用于apt，权限正确）
          sudo apt clean
          sudo apt autoclean
          
          # 2. 备份原有sources.list（sudo确保有权限备份系统文件）
          sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
          
          # 3. 关键修复：用sudo tee写入官方源（tee在sudo下运行，写入有权限）
          # 避免用cat >，改用tee解决重定向权限问题
          echo "deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ jammy-backports main restricted universe multiverse
          deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse" | sudo tee /etc/apt/sources.list > /dev/null
          
          # 4. 强制同步源（--fix-missing修复索引缺失）
          echo "=== 同步APT源 ==="
          sudo apt update -y --fix-missing || sudo apt update -y --fix-missing

      - name: 阶段2：单独安装which包（确保权限+源正常）
        run: |
          echo "=== 优先安装which包 ==="
          # 用sudo apt-get确保安装权限
          if ! sudo apt-get install -y which; then
            # 备用：直接下载deb包，用sudo dpkg安装
            echo "=== APT安装失败，尝试deb包安装 ==="
            sudo apt-get install -y wget
            wget http://archive.ubuntu.com/ubuntu/pool/main/w/which/which_2.21-7ubuntu3_amd64.deb -O which.deb
            sudo dpkg -i which.deb || sudo apt-get install -f -y  # 修复依赖
          fi
          # 验证安装结果（which命令需在sudo外运行，正常用户也能调用）
          if which which >/dev/null; then
            echo "✅ which安装成功：$(which which)"
          else
            echo "❌ which安装失败，终止流程"
            exit 1
          fi

      - name: 阶段3：安装剩余基础依赖（用户指定）
        run: |
          echo "=== 安装基础依赖 ==="
          sudo apt-get install -y \
            git binutils bzip2 diffutils findutils flex gawk gcc \
            util-linux grep coreutils libc6-dev zlib1g-dev \
            make perl python3 rsync subversion unzip
          
          echo "=== 安装Python依赖 ==="
          sudo apt install -y python3-pyelftools python3-setuptools swig
          sudo apt install -y python3-dev python3-pip
          
          echo "=== 安装硬件工具 ==="
          sudo apt install -y u-boot-tools
          sudo apt-get install -y device-tree-compiler libfdt-dev
          
          # 验证所有关键依赖
          echo "=== 依赖验证 ==="
          for pkg in which util-linux u-boot-tools python3-pip; do
            if dpkg -l | grep -q "$pkg"; then
              echo "✅ $pkg 已安装"
            else
              echo "❌ $pkg 缺失，重试安装..."
              sudo apt-get install -y "$pkg" --fix-missing
            fi
          done

      - name: 阶段4：拉取iStoreOS源码
        run: |
          git clone --depth 1 https://github.com/istoreos/istoreos.git istoreos-src
          cd istoreos-src
          git checkout main

      - name: 阶段5：安装iStoreOS feeds包
        run: |
          cd istoreos-src
          ./scripts/feeds update -a
          ./scripts/feeds install libpam libev attr curl liblzma libnetsnmp luci-theme-argon
          ./scripts/feeds install modemmanager uqmi umbim luci-proto-qmi luci-proto-mbim

      - name: 阶段6：复制配置+设备树+开机脚本
        run: |
          cd istoreos-src
          cp ../xgp.config .config
          cp ../device-tree/rk3568-xiguapi-v3.dts target/linux/rockchip/dts/armv8/
          mkdir -p package/base-files/files/etc/uci-defaults/
          cp ../custom-scripts/* package/base-files/files/etc/uci-defaults/
          chmod +x package/base-files/files/etc/uci-defaults/*

      - name: 阶段7：生成编译配置
        run: |
          cd istoreos-src
          make defconfig

      - name: 阶段8：编译固件（日志重定向）
        run: |
          cd istoreos-src
          make -j$(nproc) V=s > compile.log 2>&1
        env:
          FORCE_UNSAFE_CONFIGURE: 1

      - name: 阶段9：日志清理（保留最近1分钟）
        run: |
          cd istoreos-src
          ONE_MINUTE_AGO=$(date -d "1 minute ago" +"%H:%M")
          if [ -f "compile.log" ] && grep -q "\[..:..:..\]" "compile.log"; then
            awk -v ago="$ONE_MINUTE_AGO" '
              /^\[..:..:..\]/ {
                log_hhmm = substr($0, 2, 5);
                if (log_hhmm >= ago) print $0;
              }
              !/^\[..:..:..\]/ { print $0; }
            ' compile.log > compile_cleaned.log
            mv compile_cleaned.log compile.log
            echo "=== 日志清理完成 ==="
          fi

      - name: 阶段10：收集产物
        run: |
          mkdir -p firmware-output
          cp istoreos-src/bin/targets/rockchip/armv8/*.img.gz firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.bin firmware-output/
          cp istoreos-src/compile.log firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.manifest firmware-output/

      - name: 阶段11：上传到GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.firmware_version }}-${{ github.sha }}
          files: firmware-output/*
          body: |
            ### 关键修复
            1. 用`sudo tee`替代`cat >`，解决/etc/apt/sources.list写入权限问题
            2. 所有系统文件操作均确保sudo覆盖，避免Permission denied
            ### 功能清单
            - WIFI开机自启（SSID：iStoreOS-Xiguapi，密码：12345678）
            - 5G运营商自动识别（QMI/MBIM协议，APN自动匹配）
            - 网口转发+防火墙（LAN→WAN/5G流量转发）
            - 日志仅保留最后1分钟，减少产物大小
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
