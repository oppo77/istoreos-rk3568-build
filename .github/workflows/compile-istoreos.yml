name: 编译iStoreOS（手动触发+修复依赖）
on:
  # 1. 关闭自动运行：删除push触发，仅保留手动触发（workflow_dispatch）
  workflow_dispatch:
    # 可选：添加手动触发时的参数（如选择固件版本）
    inputs:
      firmware_version:
        description: '固件版本备注（如v1.0.0）'
        required: false
        default: 'dev-build'

jobs:
  compile:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 修复依赖安装（解决getopt/which缺失+忽略内核警告）
        run: |
          # 忽略内核版本警告：Azure Runner内核由平台管理，不影响交叉编译
          echo "=== 忽略内核版本警告（不影响iStoreOS编译）==="
          
          # 2. 修复依赖：getopt属于util-linux包，which单独安装
          sudo apt update -y
          sudo apt full-upgrade -y
          
          # 核心依赖（替换getopt为util-linux，新增which）
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
            genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
            python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
            swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev u-boot-tools libfdt-dev \
            util-linux which  # 关键修复：util-linux含getopt，新增which
          
          # 补充依赖（去重）
          sudo apt-get install -y binutils bzip2 diffutils findutils flex gawk gcc \
            grep coreutils libc6-dev zlib1g-dev make perl python3 rsync subversion unzip
          
          # Python依赖
          sudo apt install -y python3-dev python3-pip
          sudo pip3 install --upgrade pip

      - name: 拉取iStoreOS源码
        run: |
          git clone --depth 1 https://github.com/istoreos/istoreos.git istoreos-src
          cd istoreos-src
          git checkout main  # 稳定版本可替换为tag（如v23.05.01）

      - name: 复制配置文件+设备树+功能脚本
        run: |
          cp xgp.config istoreos-src/.config
          cp device-tree/rk3568-xiguapi-v3.dts istoreos-src/target/linux/rockchip/dts/armv8/
          
          # 复制功能脚本到uci-defaults（开机自动执行）
          mkdir -p istoreos-src/package/base-files/files/etc/uci-defaults/
          cp custom-scripts/* istoreos-src/package/base-files/files/etc/uci-defaults/
          chmod +x istoreos-src/package/base-files/files/etc/uci-defaults/*

      - name: 生成编译配置
        run: |
          cd istoreos-src
          make defconfig

      - name: 编译固件
        run: |
          cd istoreos-src
          make -j$(nproc) V=s
        env:
          FORCE_UNSAFE_CONFIGURE: 1

      - name: 收集编译产物
        run: |
          mkdir -p firmware-output
          cp istoreos-src/bin/targets/rockchip/armv8/*.img.gz firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.bin firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.dtb firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.manifest firmware-output/

      - name: 上传产物到GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.firmware_version }}-${{ github.sha }}
          files: firmware-output/*
          body: |
            手动编译产物（版本：${{ github.event.inputs.firmware_version }}）
            功能：WIFI自启+5G自动识别运营商+网口转发+防火墙
            设备：rk3568-xiguapi-v3
            配置文件：xgp.config
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
