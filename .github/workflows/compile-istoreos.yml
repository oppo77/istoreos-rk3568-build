name: 编译iStoreOS（修复空包名+抑制内核警告）
on:
  workflow_dispatch:
    inputs:
      firmware_version:
        description: '固件版本备注（如v1.0.0）'
        required: false
        default: 'dev-build'

jobs:
  compile:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 阶段1：抑制Azure内核警告+同步APT源
        run: |
          # 关键：将Azure内核诊断警告重定向到/dev/null，避免干扰后续步骤
          sudo apt update -y 2>/dev/null || true
          # 强制同步源，确保包列表无缓存问题
          sudo apt full-upgrade -y 2>/dev/null || true
          echo "=== 已抑制内核警告，开始安装依赖 ==="

      - name: 阶段2：安装基础依赖（无空包名，严格按用户清单）
        run: |
          # 1. 安装用户指定的基础编译依赖（无多余空格，替换getopt为util-linux）
          sudo apt-get install -y \
            git binutils bzip2 diffutils findutils flex gawk gcc \
            util-linux grep coreutils libc6-dev zlib1g-dev \
            make perl python3 rsync subversion unzip which
          
          # 2. 安装Python相关依赖（用户指定）
          sudo apt install -y python3-pyelftools python3-setuptools swig
          sudo apt install -y python3-dev python3-pip
          
          # 3. 安装硬件工具依赖（用户指定）
          sudo apt install -y u-boot-tools
          sudo apt-get install -y device-tree-compiler libfdt-dev
          
          # 4. 验证关键包是否安装成功（避免空包名导致的漏装）
          echo "=== 依赖验证 ==="
          for pkg in which util-linux u-boot-tools device-tree-compiler; do
            if dpkg -l | grep -q "$pkg"; then
              echo "✅ $pkg 已安装"
            else
              echo "❌ $pkg 未安装，手动重试..."
              sudo apt-get install -y "$pkg" --fix-missing
            fi
          done

      - name: 阶段3：拉取iStoreOS源码
        run: |
          git clone --depth 1 https://github.com/istoreos/istoreos.git istoreos-src
          cd istoreos-src
          git checkout main  # 稳定版本可替换为v23.05.01

      - name: 阶段4：安装iStoreOS feeds包（用户指定）
        run: |
          cd istoreos-src
          # 先更新feeds索引（必需，避免包找不到）
          ./scripts/feeds update -a
          # 安装用户指定的feeds包（无空包名，确保每个包名有效）
          ./scripts/feeds install libpam libev attr curl liblzma libnetsnmp luci-theme-argon
          # 补充5G/WIFI必需的feeds包
          ./scripts/feeds install modemmanager uqmi umbim luci-proto-qmi luci-proto-mbim

      - name: 阶段5：复制配置文件+设备树+开机脚本
        run: |
          cd istoreos-src
          # 复制配置文件（xgp.config→.config）
          cp ../xgp.config .config
          # 复制设备树（确保路径正确）
          cp ../device-tree/rk3568-xiguapi-v3.dts target/linux/rockchip/dts/armv8/
          # 复制开机脚本（WIFI/5G/转发/防火墙）
          mkdir -p package/base-files/files/etc/uci-defaults/
          cp ../custom-scripts/* package/base-files/files/etc/uci-defaults/
          chmod +x package/base-files/files/etc/uci-defaults/*

      - name: 阶段6：生成编译配置
        run: |
          cd istoreos-src
          make defconfig  # 自动处理依赖关联

      - name: 阶段7：编译固件（日志重定向）
        run: |
          cd istoreos-src
          make -j$(nproc) V=s > compile.log 2>&1  # 日志写入文件，便于清理
        env:
          FORCE_UNSAFE_CONFIGURE: 1

      - name: 阶段8：日志清理（仅保留最近1分钟）
        run: |
          cd istoreos-src
          ONE_MINUTE_AGO=$(date -d "1 minute ago" +"%H:%M")
          if [ -f "compile.log" ] && grep -q "\[..:..:..\]" "compile.log"; then
            awk -v ago="$ONE_MINUTE_AGO" '
              /^\[..:..:..\]/ {
                log_hhmm = substr($0, 2, 5);
                if (log_hhmm >= ago) print $0;
              }
              !/^\[..:..:..\]/ { print $0; }
            ' compile.log > compile_cleaned.log
            mv compile_cleaned.log compile.log
            echo "=== 日志清理完成，大小：$(du -sh compile.log | awk '{print $1}') ==="
          else
            echo "=== 日志无时间戳，保留全部 ==="
          fi

      - name: 阶段9：收集产物
        run: |
          mkdir -p firmware-output
          # 复制固件文件
          cp istoreos-src/bin/targets/rockchip/armv8/*.img.gz firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.bin firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.dtb firmware-output/
          # 复制日志和清单
          cp istoreos-src/compile.log firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.manifest firmware-output/

      - name: 阶段10：上传产物到Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.firmware_version }}-${{ github.sha }}
          files: firmware-output/*
          body: |
            ### 编译信息
            - 版本：${{ github.event.inputs.firmware_version }}
            - 设备：rk3568-xiguapi-v3
            - 依赖：已修复空包名问题，所有指定包均安装
            
            ### 功能
            1. WIFI开机自启（SSID：iStoreOS-Xiguapi，密码：12345678）
            2. 5G自动识别运营商（QMI/MBIM协议）
            3. 网口转发+防火墙
            4. 内核警告已抑制，日志仅保留最后1分钟
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
