name: 编译iStoreOS（根治which包缺失+源修复）
on:
  workflow_dispatch:
    inputs:
      firmware_version:
        description: '固件版本备注（如v1.0.0）'
        required: false
        default: 'dev-build'

jobs:
  compile:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 阶段1：彻底修复APT源（核心步骤）
        run: |
          echo "=== 开始修复APT源，解决which包缺失问题 ==="
          # 1. 清理APT缓存（避免旧缓存干扰）
          sudo apt clean
          sudo apt autoclean
          
          # 2. 切换到Ubuntu官方主源（放弃Azure可能有问题的镜像源）
          # 备份原有sources.list
          sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
          # 写入Ubuntu 22.04官方源（focal），确保main仓库启用
          sudo cat > /etc/apt/sources.list << EOF
          deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ jammy-backports main restricted universe multiverse
          deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse
          EOF
          
          # 3. 强制同步源，启用--fix-missing处理索引缺失
          sudo apt update -y --fix-missing
          if [ $? -ne 0 ]; then
            echo "=== 首次update失败，重试一次 ==="
            sudo apt update -y --fix-missing
          fi
          
          # 4. 验证APT源是否正常加载main仓库
          echo "=== 验证main仓库是否启用 ==="
          apt-cache policy | grep -E "jammy main|jammy-updates main"
          if [ $? -eq 0 ]; then
            echo "✅ main仓库已启用，源修复完成"
          else
            echo "❌ main仓库未启用，手动启用..."
            sudo apt-add-repository main
            sudo apt update -y
          fi

      - name: 阶段2：单独安装which包（优先验证）
        run: |
          echo "=== 优先安装which包，确认源修复效果 ==="
          # 单独安装which，避免与其他包混合导致的排查困难
          if ! sudo apt-get install -y which; then
            echo "=== which包安装失败，手动下载deb包安装 ==="
            # 备用方案：直接从Ubuntu官网下载which的deb包安装（彻底规避APT源问题）
            sudo apt-get install -y wget
            # 下载Ubuntu 22.04（arm64/x86_64通用，APT会自动适配架构）
            wget http://archive.ubuntu.com/ubuntu/pool/main/w/which/which_2.21-7ubuntu3_amd64.deb -O which.deb
            sudo dpkg -i which.deb || sudo apt-get install -f -y  # 修复依赖
          fi
          # 验证which是否安装成功
          if which which >/dev/null; then
            echo "✅ which包安装成功，路径：$(which which)"
          else
            echo "❌ which包仍未安装，终止流程"
            exit 1
          fi

      - name: 阶段3：安装剩余基础依赖（用户指定）
        run: |
          echo "=== 安装剩余基础依赖 ==="
          # 安装用户指定的其他依赖（替换getopt为util-linux）
          sudo apt-get install -y \
            git binutils bzip2 diffutils findutils flex gawk gcc \
            util-linux grep coreutils libc6-dev zlib1g-dev \
            make perl python3 rsync subversion unzip
          
          # 安装Python依赖
          sudo apt install -y python3-pyelftools python3-setuptools swig
          sudo apt install -y python3-dev python3-pip
          
          # 安装硬件工具依赖
          sudo apt install -y u-boot-tools
          sudo apt-get install -y device-tree-compiler libfdt-dev
          
          # 验证所有关键依赖
          echo "=== 最终依赖验证 ==="
          for pkg in which util-linux u-boot-tools device-tree-compiler python3-pip; do
            if dpkg -l | grep -q "$pkg"; then
              echo "✅ $pkg 已安装"
            else
              echo "❌ $pkg 未安装，重试安装..."
              sudo apt-get install -y "$pkg" --fix-missing
            fi
          done

      - name: 阶段4：拉取iStoreOS源码
        run: |
          git clone --depth 1 https://github.com/istoreos/istoreos.git istoreos-src
          cd istoreos-src
          git checkout main

      - name: 阶段5：安装iStoreOS feeds包
        run: |
          cd istoreos-src
          ./scripts/feeds update -a
          ./scripts/feeds install libpam libev attr curl liblzma libnetsnmp luci-theme-argon
          ./scripts/feeds install modemmanager uqmi umbim luci-proto-qmi luci-proto-mbim

      - name: 阶段6：复制配置+设备树+脚本
        run: |
          cd istoreos-src
          cp ../xgp.config .config
          cp ../device-tree/rk3568-xiguapi-v3.dts target/linux/rockchip/dts/armv8/
          mkdir -p package/base-files/files/etc/uci-defaults/
          cp ../custom-scripts/* package/base-files/files/etc/uci-defaults/
          chmod +x package/base-files/files/etc/uci-defaults/*

      - name: 阶段7：生成编译配置
        run: |
          cd istoreos-src
          make defconfig

      - name: 阶段8：编译固件（日志重定向）
        run: |
          cd istoreos-src
          make -j$(nproc) V=s > compile.log 2>&1
        env:
          FORCE_UNSAFE_CONFIGURE: 1

      - name: 阶段9：日志清理（保留最近1分钟）
        run: |
          cd istoreos-src
          ONE_MINUTE_AGO=$(date -d "1 minute ago" +"%H:%M")
          if [ -f "compile.log" ] && grep -q "\[..:..:..\]" "compile.log"; then
            awk -v ago="$ONE_MINUTE_AGO" '
              /^\[..:..:..\]/ {
                log_hhmm = substr($0, 2, 5);
                if (log_hhmm >= ago) print $0;
              }
              !/^\[..:..:..\]/ { print $0; }
            ' compile.log > compile_cleaned.log
            mv compile_cleaned.log compile.log
          fi

      - name: 阶段10：收集产物+上传
        run: |
          mkdir -p firmware-output
          cp istoreos-src/bin/targets/rockchip/armv8/*.img.gz firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.bin firmware-output/
          cp istoreos-src/compile.log firmware-output/
          cp istoreos-src/bin/targets/rockchip/armv8/*.manifest firmware-output/

      - name: 阶段11：上传到Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.firmware_version }}-${{ github.sha }}
          files: firmware-output/*
          body: |
            ### 关键修复
            - 已切换Ubuntu官方源，根治which包缺失问题
            - 优先单独安装which，确保依赖基础
            ### 功能
            1. WIFI开机自启 2. 5G运营商自动识别 3. 网口转发+防火墙
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
