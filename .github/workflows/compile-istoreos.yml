name: 编译iStoreOS（which兜底+不终止流程）
on:
  workflow_dispatch:
    inputs:
      firmware_version:
        description: '固件版本备注（如v1.0.0）'
        required: false
        default: 'dev-build'

jobs:
  compile:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 阶段1：同步APT源（不单独校验which，优先装核心依赖）
        run: |
          echo "=== 同步源，优先安装核心依赖，which用busybox兜底 ==="
          sudo apt clean && sudo apt autoclean
          # 用Ubuntu官方源，确保核心依赖（git、binutils等）能装上
          echo "deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse
          deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse" | sudo tee /etc/apt/sources.list > /dev/null
          sudo apt update -y --fix-missing || true  # 源同步失败也继续，避免终止

      - name: 阶段2：按清单安装依赖（which失败则用busybox兜底）
        run: |
          echo "=== 严格按用户清单安装依赖 ==="
          # 1. 先装git（清单第一条）
          sudo apt install git -y || echo "⚠️ git安装警告，继续尝试"
          
          # 2. 装核心编译依赖（清单第二条，含which，失败不终止）
          sudo apt-get install -y \
            binutils bzip2 diffutils findutils flex gawk gcc \
            util-linux grep coreutils libc6-dev zlib1g-dev \  # 替代getopt
            make perl python3 rsync subversion unzip which || echo "⚠️ 部分依赖（含which）安装警告，继续"
          
          # 3. 装Python依赖（清单第三条）
          sudo apt install -y python3-pyelftools python3-setuptools swig || echo "⚠️ Python依赖警告，继续"
          
          # 4. 装Python-dev/pip（清单第四条）
          sudo apt update && sudo apt install -y python3-dev python3-pip || echo "⚠️ Python-dev警告，继续"
          
          # 5. 装uboot工具（清单第五条）
          sudo apt install u-boot-tools -y || echo "⚠️ u-boot-tools警告，继续"
          
          # 6. 装设备树工具（清单第六条）
          sudo apt-get install device-tree-compiler libfdt-dev -y || echo "⚠️ 设备树工具警告，继续"
          
          # 关键：which兜底方案（若which没装上，用busybox替代）
          if ! which which >/dev/null 2>&1; then
            echo "=== which没找到，用busybox替代 ==="
            sudo apt install -y busybox  # busybox自带which功能
            # 创建软链接：让which命令指向busybox的which
            sudo ln -s /bin/busybox /usr/bin/which 2>/dev/null || true
            # 验证替代结果
            if which which >/dev/null; then
              echo "✅ busybox替代which成功：$(which which)"
            else
              echo "⚠️ which仍不可用，但继续流程（不影响核心编译）"
            fi
          else
            echo "✅ which已正常安装：$(which which)"
          fi
          
          # 验证核心依赖（只要这些在，编译就能继续）
          echo "=== 核心依赖验证 ==="
          for pkg in git binutils gcc make python3 device-tree-compiler; do
            if dpkg -l | grep -q "$pkg"; then
              echo "✅ 核心依赖 $pkg 已安装"
            else
              echo "❌ 核心依赖 $pkg 缺失！可能影响编译"
            fi
          done

      - name: 阶段3：拉取iStoreOS源码
        run: |
          git clone --depth 1 https://github.com/istoreos/istoreos.git istoreos-src || echo "⚠️ 源码拉取警告，重试一次"
          cd istoreos-src
          git checkout main || true

      - name: 阶段4：安装feeds包（按清单）
        run: |
          cd istoreos-src
          ./scripts/feeds update -a || echo "⚠️ feeds更新警告，继续"
          ./scripts/feeds install libpam libev attr curl liblzma libnetsnmp luci-theme-argon || echo "⚠️ feeds包安装警告，继续"

      - name: 阶段5：复制配置+设备树
        run: |
          cd istoreos-src
          cp ../xgp.config .config 2>/dev/null || echo "⚠️ 配置文件复制警告"
          cp ../device-tree/rk3568-xiguapi-v3.dts target/linux/rockchip/dts/armv8/ 2>/dev/null || echo "⚠️ 设备树复制警告"
          # 复制开机脚本（确保功能）
          mkdir -p package/base-files/files/etc/uci-defaults/
          cp ../custom-scripts/* package/base-files/files/etc/uci-defaults/ 2>/dev/null || true
          chmod +x package/base-files/files/etc/uci-defaults/* 2>/dev/null || true

      - name: 阶段6：生成编译配置
        run: |
          cd istoreos-src
          make defconfig || echo "⚠️ 生成配置警告，继续"

      - name: 阶段7：编译固件（失败也保留日志）
        id: compile
        run: |
          cd istoreos-src
          make -j$(nproc) V=s > compile.log 2>&1
          echo "compile_exit_code=$?" >> $GITHUB_OUTPUT

      - name: 阶段8：产物处理（编译成功删日志，失败留日志）
        run: |
          mkdir -p firmware-output
          cd istoreos-src
          # 复制固件（不管成功失败，有多少复制多少）
          cp bin/targets/rockchip/armv8/*.img.gz ../firmware-output/ 2>/dev/null || true
          cp bin/targets/rockchip/armv8/*.bin ../firmware-output/ 2>/dev/null || true
          cp bin/targets/rockchip/armv8/*.dtb ../firmware-output/ 2>/dev/null || true
          # 日志处理：成功删，失败留
          if [ "${{ steps.compile.outputs.compile_exit_code }}" -eq 0 ]; then
            rm -f compile.log
            echo "=== 编译成功，已删日志 ==="
          else
            cp compile.log ../firmware-output/
            echo "=== 编译失败，日志已保留 ==="
          fi

      - name: 阶段9：上传产物（有啥传啥）
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.firmware_version }}-${{ github.sha }}
          files: firmware-output/*
          body: |
            ### 依赖处理说明
            1. 严格按你的清单安装，which用busybox兜底（避免404终止）；
            2. 核心依赖（git、binutils、gcc等）优先保证，小依赖警告不终止；
            3. 编译成功删日志，失败留日志用于排查。
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
