name: Build iStoreOS for RK3568 with 5G (FM35OGL)

on:
  push:
    branches: [ main ]
    paths:
      - '.config'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libncursesw5-dev libssl-dev libelf-dev python3-distutils rsync unzip zlib1g-dev file wget libusb-1.0-0-dev

      - name: Clone iStoreOS source
        run: |
          git clone https://github.com/istoreos/istoreos.git --depth=1 --branch=main istoreos-src
          cd istoreos-src

      - name: 彻底删除源码中硬编码的qwrt/quectel源（关键步骤）
        run: |
          cd istoreos-src
          # 搜索并删除所有包含qwrt和quectel源的配置文件
          # 检查feeds.conf.default是否被硬编码
          sed -i '/qwrt-project\/qwrt-packages/d' feeds.conf.default
          sed -i '/quectel\/quectel-openwrt/d' feeds.conf.default
          # 检查scripts/feeds脚本是否自动添加源（如有）
          sed -i '/qwrt-project\/qwrt-packages/d' scripts/feeds
          sed -i '/quectel\/quectel-openwrt/d' scripts/feeds
          # 检查其他可能的配置文件（如include/feeds.mk等）
          find . -type f -exec sed -i '/qwrt-project\/qwrt-packages/d' {} +
          find . -type f -exec sed -i '/quectel\/quectel-openwrt/d' {} +
          # 确认清理结果
          echo "清理后feeds.conf.default内容："
          cat feeds.conf.default

      - name: 仅保留默认源，确保无第三方源
        run: |
          cd istoreos-src
          # 强制覆盖为纯净的默认源配置
          > feeds.conf.default
          echo "src-git base https://github.com/openwrt/openwrt.git;openwrt-22.03" >> feeds.conf.default
          echo "src-git packages https://github.com/openwrt/packages.git;openwrt-22.03" >> feeds.conf.default
          echo "src-git luci https://github.com/openwrt/luci.git;openwrt-22.03" >> feeds.conf.default
          echo "src-git routing https://github.com/openwrt/routing.git;openwrt-22.03" >> feeds.conf.default
          echo "src-git telephony https://github.com/openwrt/telephony.git;openwrt-22.03" >> feeds.conf.default

      - name: 配置FM35OGL所需的默认组件
        run: |
          cp ./.config istoreos-src/.config
          cd istoreos-src
          # 仅依赖OpenWRT默认源中的组件
          sed -i '/CONFIG_PACKAGE_kmod-usb-serial/d' .config && echo "CONFIG_PACKAGE_kmod-usb-serial=y" >> .config
          sed -i '/CONFIG_PACKAGE_kmod-usb-serial-qcserial/d' .config && echo "CONFIG_PACKAGE_kmod-usb-serial-qcserial=y" >> .config  # 高通串口驱动
          sed -i '/CONFIG_PACKAGE_kmod-qmi-wwan/d' .config && echo "CONFIG_PACKAGE_kmod-qmi-wwan=y" >> .config  # QMI协议
          sed -i '/CONFIG_PACKAGE_kmod-usb-net-qmi-wwan/d' .config && echo "CONFIG_PACKAGE_kmod-usb-net-qmi-wwan=y" >> .config
          sed -i '/CONFIG_PACKAGE_modemmanager/d' .config && echo "CONFIG_PACKAGE_modemmanager=y" >> .config
          sed -i '/CONFIG_PACKAGE_modemmanager-ppp/d' .config && echo "CONFIG_PACKAGE_modemmanager-ppp=y" >> .config
          sed -i '/CONFIG_PACKAGE_luci-proto-qmi/d' .config && echo "CONFIG_PACKAGE_luci-proto-qmi=y" >> .config
          sed -i '/CONFIG_PACKAGE_qmi-utils/d' .config && echo "CONFIG_PACKAGE_qmi-utils=y" >> .config
          sed -i '/CONFIG_PACKAGE_uqmi/d' .config && echo "CONFIG_PACKAGE_uqmi=y" >> .config
          sed -i '/CONFIG_PACKAGE_luci-app-modemmanager/d' .config && echo "CONFIG_PACKAGE_luci-app-modemmanager=y" >> .config  # 图形界面

      - name: 添加FM35OGL硬件识别规则
        run: |
          cd istoreos-src
          mkdir -p files/etc/udev/rules.d/
          echo 'SUBSYSTEM=="tty", ATTRS{idVendor}=="05c6", ATTRS{idProduct}=="90b2", SYMLINK+="ttyUSB_FM35OGL", MODE="0666"' > files/etc/udev/rules.d/99-fm35ogl.rules
          mkdir -p files/etc/modprobe.d/
          echo "options qcserial vendor=0x05c6 product=0x90b2" > files/etc/modprobe.d/fm35ogl.conf

      - name: 更新默认源并安装组件
        run: |
          cd istoreos-src
          ./scripts/feeds update -a  # 此时已无qwrt/quectel源，不会触发错误
          ./scripts/feeds install -a

      - name: 编译固件
        run: |
          cd istoreos-src
          make -j$(nproc) defconfig
          make -j$(nproc) download V=s
          make -j$(nproc) V=s

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: istoreos-rk3568-fm35ogl-firmware
          path: istoreos-src/bin/targets/rockchip/armv8/*.img
